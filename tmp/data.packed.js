(function(){function p(a,b){var c={},d;if(a&&a.length)d=c.inserted=a;if(b&&b.length)d=c.deleted=b;if(d)return c}function v(a){return function(b){if(b instanceof o){if(this.sources.add(b))return b.addHandler(a,this),a.datasetChanged.call(this,b,{inserted:b.getItems()}),this.isActiveSubscriber&&this.subscriptionType&4&&b.addSubscriber(this,4),!0}else typeof console!="undefined"&&console.warn(this.className+".addSource: source isn't type of AbstractDataset")}}function w(a){return function(b){if(this.sources.remove(b))return b.removeHandler(a,
this),a.datasetChanged.call(this,b,{deleted:b.getItems()}),this.isActiveSubscriber&&this.subscriptionType&4&&b.removeSubscriber(this,4),!0;else typeof console!="undefined"&&console.warn(this.className+".removeSource: source isn't in dataset source list")}}function x(a){return function(){for(var b=0,c;c=this.sources[b];b++)c.removeHandler(a,this),a.datasetChanged.call(this,c,{deleted:c.getItems()}),this.isActiveSubscriber&&this.subscriptionType&4&&c.removeSubscriber(this,4);this.sources.clear();this.map_=
{}}}function y(a,b,c,d){if(!a.length)return 0;var e,c=isNaN(c)?0:c,g=isNaN(d)?a.length-1:d;do if(d=c+g>>1,cmpValue=a[d].value||0,cmpValue===e?(cmpValue=a[d].object.eventObjectId,e=b.object.eventObjectId):e=b.value||0,e<cmpValue)g=d-1;else if(e>cmpValue)c=d+1;else return e==cmpValue?d:0;while(c<=g);return d+(cmpValue<e)}function B(a){a=parseInt(a)||0;return a>=0?a:0}function C(a){a=parseInt(a);return a>=1?a:1}var l=Basis.Class,q=Function.getter,z={update:function(a,b){this.updateCount+=1;this.info=
a.info;this.dispatch("update",a,b)},stateChanged:function(a,b){this.state=a.state;this.dispatch("stateChanged",a,b)},destroy:function(){this.cascadeDestroy?this.destroy():this.setDelegate()}},j=l(Basis.EventObject,{className:"Basis.Data.DataObject",state:"ready",info:null,updateCount:0,canHaveDelegate:!0,delegate:null,cascadeDestroy:!1,collection:null,subscriberCount:0,subscribers_:null,isActiveSubscriber:!1,subscriptionType:3,init:function(a){this.inherit(a);this.subscribers_={};this.updateCount=
0;this.info={};if(a){if(typeof a.isActiveSubscriber=="boolean")this.isActiveSubscriber=a.isActiveSubscriber;if(!isNaN(a.subscriptionType))this.subscriptionType=a.subscriptionType;if(typeof a.cascadeDestroy=="boolean")this.cascadeDestroy=a.cascadeDestroy;if(a.state)this.state=a.state;var b=a.delegate;if(!b&&a.info instanceof j)b=a.info;if(b)this.setDelegate(b);else if(a.info){var b={},c;for(c in a.info)this.info[c]=a.info[c],b[c]=void 0;this.dispatch("update",this,b)}a.collection&&this.setCollection(a.collection)}else this.state=
Object(String(this.state));this.state==this.constructor.prototype.state&&(this.behaviour.stateChanged||this.handlers_.length)&&this.dispatch("stateChanged",this,void 0);return a||{}},isConnected:function(a){if(a instanceof j){for(;a&&a!==this&&a!==a.delegate;)a=a.delegate;return a===this}return!1},getRootDelegate:function(){for(var a=this;a.delegate&&a.delegate!==a;)a=a.delegate;return a},setDelegate:function(a){if(this.canHaveDelegate&&this.delegate!==a){var b={},c=this.delegate,d=this.isActiveSubscriber&&
this.subscriptionType&1;if(c){c.removeHandler(z,this);for(var e in this.info)b[e]=this.info[e];this.info={};d&&c.removeSubscriber(this,1);delete this.delegate}if(a instanceof j)if(this.isConnected(a))typeof console!="undefined"&&console.warn("(debug) New delegate has already connected to object. Delegate assign has been ignored.",this,a);else{d&&a.addSubscriber(this,1);this.setState(a.state,a.state.data);for(e in a.info)e in b?a.info[e]===b[e]&&delete b[e]:a.info[e]!==this.info[e]&&(b[e]=this.info[e]);
this.delegate=a;this.info=a.info;a.addHandler(z,this)}this.dispatch("delegateChanged",this,c);this.dispatch("update",this,b)}return this.delegate},setState:function(a,b){if(this.state!=String(a)||this.state.data!=b){var c=this.state,d=this.getRootDelegate();if(d!==this)return d.setState(a,b);this.state=Object(String(a));this.state.data=b;this.dispatch("stateChanged",this,c)}return this.state},deprecate:function(){this.state!="processing"&&this.setState("deprecated")},setCollection:function(a){if(this.collection!=
a){var b=this.collection;b&&(this.isActiveSubscriber&&this.subscriptionType&2&&b.removeSubscriber(this,2),delete this.collection);if(a instanceof o)this.collection=a,this.isActiveSubscriber&&this.subscriptionType&2&&a.addSubscriber(this,2);this.dispatch("collectionChanged",this,b);return!0}return!1},update:function(a){var b=this.getRootDelegate();if(b!==this)return b.update(a);if(a){var b={},c=0,d;for(d in a)this.info[d]!==a[d]&&(c++,b[d]=this.info[d],this.info[d]=a[d]);if(c)return this.updateCount+=
c,this.dispatch("update",this,b),b}return!1},addSubscriber:function(a,b){!b&&typeof console!="undefined"&&console.warn("addSubscriber has no subscriberType argument");var c=b+"_"+a.eventObjectId;if(!this.subscribers_[c])return this.subscribers_[c]=a,this.subscriberCount+=1,this.dispatch("subscribersChanged"),!0;return!1},removeSubscriber:function(a,b){!b&&typeof console!="undefined"&&console.warn("removeSubscriber has no subscriberType argument");var c=b+"_"+a.eventObjectId;if(this.subscribers_[c])return delete this.subscribers_[c],
this.subscriberCount-=1,this.dispatch("subscribersChanged"),!0;return!1},setIsActiveSubscriber:function(a){if(this.isActiveSubscriber!=!!a){var b=this.delegate,c=this.collection,d=this.subscriptionType;b&&d&1&&(a?b.addSubscriber(this,1):b.removeSubscriber(this,1));c&&d&2&&(a?c.addSubscriber(this,2):c.removeSubscriber(this,2));this.isActiveSubscriber=!!a;this.dispatch("isActiveStateChanged");return!0}return!1},setSubscriptionType:function(a){var b=this.subscriptionType;if(b!=a){if(this.isActiveSubscriber){var c=
this.delegate,d=this.collection,e=d&&a&2^b&2;c&&a&1^b&1&&(b&1?c.removeSubscriber(this,1):c.addSubscriber(this,1));e&&(b&2?d.removeSubscriber(this,2):d.addSubscriber(this,2))}this.subscriptionType=a;return!0}return!1},destroy:function(){var a=this.delegate;if(a)this.info={},a.removeHandler(z,this),this.isActiveSubscriber&&this.subscriptionType&1&&a.removeSubscriber(this,1),delete this.delegate;this.collection&&(this.setCollection(),delete this.collection);this.inherit();delete this.state;delete this.subscribers_}}),
o=l(j,{className:"Basis.Data.AbstractDataset",canHaveDelegate:!1,state:"undefined",map_:null,member_:null,cache_:[],eventCache_:null,itemCount:0,version:0,version_:0,init:function(a){this.inherit(a);this.map_={};this.member_={};this.version=this.itemCount=0;this.eventCache_={mode:!1,delta:[]}},has:function(a){return!(!a||!this.member_[a.eventObjectId])},getItems:function(){if(this.version_!=this.version)this.version_=this.version,this.cache_=Object.values(this.member_);return this.cache_},sync:Function.$false,
add:Function.$false,remove:Function.$false,set:Function.$false,clear:Function.$false,dispatch:function(a,b,c){if(a=="datasetChanged"){var d;if(d=c.inserted){for(var e=0,g;g=d[e];e++)this.member_[g.eventObjectId]=this.map_[g.eventObjectId];this.itemCount+=d.length;this.version++}if(d=c.deleted){for(e=0;g=d[e];e++)delete this.member_[g.eventObjectId];this.itemCount-=d.length;this.version++}}this.inherit.apply(this,arguments)},destroy:function(){this.clear();this.inherit();this.getItems=Function.$null;
delete this.itemCount;delete this.map_;delete this.member_;delete this.cache_;delete this.eventCache_}}),s={destroy:function(a){this.map_[a.eventObjectId]&&this.remove([a])}},m=l(o,{className:"Basis.Data.Dataset",init:function(a){this.inherit(a);a&&a.items&&this.set(a.items)},add:function(a){for(var b,c=[],d=0;d<a.length;d++){var e=a[d];if(e instanceof j){var g=e.eventObjectId;this.map_[g]||(this.map_[g]=e,c.push(e),e.all!==this&&e.addHandler(s,this))}}c.length&&this.dispatch("datasetChanged",this,
b={inserted:c});return b},remove:function(a){for(var b,c=[],d=0;d<a.length;d++){var e=a[d];if(e instanceof j){var g=e.eventObjectId;this.map_[g]&&(delete this.map_[g],c.push(e),e.all!==this&&e.removeHandler(s,this))}}c.length&&this.dispatch("datasetChanged",this,b={deleted:c});return b},set:function(a){if(!this.itemCount)return this.add(a);if(!a.length)return this.clear();for(var b={},c=0;c<a.length;c++){var d=a[c];if(d instanceof j){var e=d.eventObjectId;b[e]=d}}a=[];for(e in this.map_)b[e]?delete b[e]:
(d=this.map_[e],delete this.map_[e],a.push(d),d.all!==this&&d.removeHandler(s,this));c=[];for(e in b)d=b[e],this.map_[e]=b[e],c.push(d),d.all!==this&&d.addHandler(s,this);if(b=p(c,a))return this.dispatch("datasetChanged",this,b),b},sync:function(a,b){if(a){m.setAccumulateState(!0);for(var c=[],d={},e=[],g=[],h=0;h<a.length;h++){var f=a[h];if(f instanceof j){var i=f.eventObjectId;d[i]=f;this.map_[i]||e.push(f)}}for(i in this.map_)d[i]||(f=this.map_[i],g.push(f),f.destroy());b&&e.length&&(c=this.add(e));
m.setAccumulateState(!1);return c}},clear:function(){var a,b=this.getItems();this.map_={};if(b.length){for(a=0;a<b.length;a++)b[a].all!==this&&b[a].removeHandler(s,this);this.dispatch("datasetChanged",this,a={deleted:b})}return a}});(function(){function a(a){var b=a.eventCache_;if(b.mode){var c={};c[b.mode]=b.delta;delete d[a.eventObjectId];b.mode=!1;b.delta=[];g.method.call(a,"datasetChanged",a,c)}}function b(){typeof console!="undefined"&&console.warn("(debug) Urgent flush dataset changes");h=0;
e.dispatch=g;Object.values(d).forEach(a)}function c(b,c,e){if(b=="datasetChanged"){var f=c,h=e,j=f.eventCache_,r=!!h.inserted,l=!!h.deleted;r&&l?(a(f),g.method.call(f,"datasetChanged",f,h)):(r=r?"inserted":"deleted",j.mode&&j.mode!=r&&a(f),j.mode=r,j.delta.push.apply(j.delta,h[r]),d[f.eventObjectId]=f)}else g.method.apply(this,arguments)}var d={},e=o.prototype,g=j.prototype.dispatch,h=0,f;m.setAccumulateState=function(i){if(i==="xxx")if(i){if(h==0)e.dispatch=c,f=setTimeout(b,0);h++}else{if(h==1)clearTimeout(f),
e.dispatch=g,Object.values(d).forEach(a);h-=h>0}}})();var n={datasetChanged:function(a,b){var c=a.eventObjectId,d=[],e=[],g,h,f;if(b.inserted)for(var i=0;g=b.inserted[i];i++)h=g.eventObjectId,f=this.map_[h],f||(f=this.map_[h]={object:g,count:0},d.push(g)),f[c]||(f[c]=a,f.count++);if(b.deleted)for(i=0;g=b.deleted[i];i++)if(h=g.eventObjectId,(f=this.map_[h])&&f[c])delete f[c],f.count--==1&&(delete this.map_[h],e.push(g));(b=p(d,e))&&this.dispatch("datasetChanged",this,b)},destroy:function(a){this.removeSource(a)}},
n=l(o,{className:"Basis.Data.AggregateDataset",subscriptionType:4,sources:null,init:function(a){this.sources=[];this.inherit(a);a&&Array.isArray(a.sources)&&a.sources.forEach(this.addSource,this)},getItems:function(){if(this.version_!=this.version)for(var a in this.version_=this.version,this.cache_=[],this.member_)this.cache_.push(this.member_[a].object);return this.cache_},setIsActiveSubscriber:function(a){if(this.isActiveSubscriber!=!!a&&this.sources.length&&this.subscriptionType&4)for(var b=0;source=
this.sources[b];b++)a?source.addSubscriber(this,4):source.removeSubscriber(this,4);return this.inherit(a)},setSubscriptionType:function(a){var b=this.subscriptionType,c=Number(a)||0;if(b!=a&&this.isActiveSubscriber&&this.sources.length&&c&4^b&4)for(a=0;source=this.sources[a];a++)c&4?source.addSubscriber(this,4):source.removeSubscriber(this,4);return this.inherit(c)},addSource:v(n),removeSource:w(n),clear:x(n),destroy:function(){this.inherit();delete this.sources}}),D={update:function(a){var b=this.map_[a.eventObjectId],
c=this.index(a),a=this.index_;if(b.value!=c){var d=y(a,b);b.value=c;var e=a[d-1],g=a[d+1];if(e&&!(e.value<=c)||g&&!(c<=g.value))if(a.splice(d,1),e=y(a,b),a.splice(e,0,b),a.length>this.offset&&(c=this.offset+this.limit,d=(d>this.offset)+(d>c),e=(e>this.offset)+(e>c),e!=d)){var h,f,g={};switch(e){case 0:f=a[this.offset];h=d==1?b:a[c];break;case 1:f=b;h=d==0?a[this.offset-1]:a[c];break;case 2:f=a[c-1],h=d==1?b:a[this.offset-1]}if(f)g.inserted=[f.object];if(h)g.deleted=[h.object];this.dispatch("datasetChanged",
this,g)}}}},t={datasetChanged:function(a,b){function c(a,b,c){if(a){var a=a.object,d=a.eventObjectId;c[d]?delete c[d]:b[d]=a}}var d=a.eventObjectId,e={},g={},h,f,i,j=this.index_;if(b.inserted)for(var k=0;h=b.inserted[k];k++)f=h.eventObjectId,i=this.map_[f],i||(i=this.map_[f]={object:h,count:0,value:this.index(h)},h.addHandler(D,this),h=y(j,i),this.index_.splice(h,0,i),j.length>this.offset&&h<this.offset+this.limit&&(c(j[this.offset+this.limit],g,e),c(h<this.offset?j[this.offset]:i,e,g))),i[d]||(i[d]=
a,i.count++);if(b.deleted)for(k=0;h=b.deleted[k];k++)if(f=h.eventObjectId,(i=this.map_[f])&&i[d])delete i[d],i.count--==1&&(i.object.removeHandler(D,this),h=y(j,i),j.length>this.offset&&h<this.offset+this.limit&&(c(j[this.offset+this.limit],e,g),c(h<this.offset?j[this.offset]:i,g,e)),j.splice(h,1),delete this.map_[f]);e=Object.values(e);g=Object.values(g);(b=p(e,g))&&this.dispatch("datasetChanged",this,b)},destroy:function(a){this.removeSource(a)}},t=l(n,{className:"Basis.Data.IndexedDataset",index:Function.$true,
offset:0,limit:10,init:function(a){this.index_=[];if(a){if(a.index)this.index=q(a.index);if("offset"in a)this.offset=B(a.offset);if("limit"in a)this.limit=C(a.limit)}this.inherit(a)},setRange:function(a,b){a=B(a);b=C(b);if(this.offset!=a||this.limit!=b){var c=[],d=[],e=this.offset+this.limit,g=a+b;a!=this.offset&&(a<this.offset?c.push.apply(c,this.index_.slice(a,Math.min(this.offset,g))):d.push.apply(d,this.index_.slice(this.offset,Math.min(a,e))));g!=e&&(g<e?d.push.apply(d,this.index_.slice(Math.max(g,
this.offset),e)):c.push.apply(c,this.index_.slice(Math.max(e,a),g)));this.offset=a;this.limit=b;c=c.map(q("object"));d=d.map(q("object"));(delta=p(c,d))&&this.dispatch("datasetChanged",this,delta)}},addSource:v(t),removeSource:w(t),clear:x(t)}),E={update:function(a){var b=this.map_[a.eventObjectId],c=!!this.filter(a);if(b.state!=c)b.state=c,this.dispatch("datasetChanged",this,c?{inserted:[a]}:{deleted:[a]})}},u={datasetChanged:function(a,b){var c=a.eventObjectId,d=[],e=[],g,h,f;if(b.inserted)for(var i=
0;g=b.inserted[i];i++)h=g.eventObjectId,f=this.map_[h],f||(f=this.map_[h]={object:g,count:0,state:!!this.filter(g)},g.addHandler(E,this),f.state&&d.push(g)),f[c]||(f[c]=a,f.count++);if(b.deleted)for(i=0;g=b.deleted[i];i++)if(h=g.eventObjectId,(f=this.map_[h])&&f[c])delete f[c],f.count--==1&&(f.object.removeHandler(E,this),f.state&&e.push(f.object),delete this.map_[h]);(b=p(d,e))&&this.dispatch("datasetChanged",this,b)},destroy:function(a){this.removeSource(a)}},u=l(n,{className:"Basis.Data.Collection",
filter:Function.$true,init:function(a){if(a&&a.filter)this.filter=q(a.filter);this.inherit(a)},setFilter:function(a){a=a?q(a):Function.$true;if(this.filter!=a){this.filter=a;var b=[],c=[],d,e,g,h;for(h in this.map_)if(d=this.map_[h],e=d.object,g=!!a(e),g!=d.state)(d.state=g)?b.push(e):c.push(e);var f;(f=p(b,c))&&this.dispatch("datasetChanged",this,f)}},addSource:v(u),removeSource:w(u),clear:x(u),sync:function(a){if(a){m.setAccumulateState(!0);for(var b={},c=[],d=0;d<a.length;d++){var e=a[d];if(e instanceof
j){var g=e.eventObjectId;b[g]=e}}for(g in this.map_)if(this.map_[g].state&&!b[g])e=this.map_[g].object,c.push(e),e.destroy();m.setAccumulateState(!1);return[]}},destroy:function(){this.inherit()}}),F={update:function(a){var b=a.eventObjectId,c=this.map_[b].group,d=this.getGroup(this.groupGetter(a),!0);if(c!==d)this.map_[b].group=d,delete c.map_[b],c.dispatch("datasetChanged",c,{deleted:[a]}),d.map_[b]=a,d.dispatch("datasetChanged",this,{inserted:[a]}),this.destroyEmpty&&!c.itemCount&&(delete this.groups_[c.groupId],
delete this.map_[c.eventObjectId],c.destroy(),this.dispatch("datasetChanged",this,{deleted:[c]}))}},A={datasetChanged:function(a,b){var c=a.eventObjectId,d=[],e=[],g,h,f,i={},j;if(b.inserted){m.setAccumulateState(!0);for(var k=0;g=b.inserted[k];k++)h=g.eventObjectId,f=this.map_[h],f||(f=this.getGroup(this.groupGetter(g),!0),f=this.map_[h]={object:g,count:0,group:f},d.push(f)),f[c]||(f[c]=a,f.count++);m.setAccumulateState(!1);for(k=0;f=d[k];k++)g=f.object,f=f.group,h=g.eventObjectId,g.addHandler(F,
this),f.map_[h]=g,j=f.eventObjectId,(h=i[j])?h.inserted.push(g):i[j]={group:f,inserted:[g],deleted:[]}}if(b.deleted)for(k=0;g=b.deleted[k];k++)if(h=g.eventObjectId,(f=this.map_[h])&&f[c])if(delete f[c],f.count--==1)f=f.group,g.removeHandler(F,this),delete f.map_[h],delete this.map_[h],j=f.eventObjectId,(h=i[j])?h.deleted.push(g):i[j]={group:f,deleted:[g]};for(j in i)b=i[j],f=b.group,b.deleted.length||delete b.deleted,f.dispatch("datasetChanged",f,b),this.destroyEmpty&&!f.itemCount&&(e.push(f),delete this.groups_[f.groupId],
delete this.map_[f.eventObjectId],f.destroy());e.length&&this.dispatch("datasetChanged",this,{deleted:e})},destroy:function(a){this.removeSource(a)}},G=x(A),l=l(n,{className:"Basis.Data.Grouping",groupGetter:Function.$true,groupClass:o,destroyEmpty:!0,init:function(a){this.groups_={};if(a){if(a.groupGetter)this.groupGetter=q(a.groupGetter);if(a.groupClass)this.groupClass=a.groupClass;if(a.destroyEmpty===!1)this.destroyEmpty=!1}this.inherit(a)},getGroup:function(a,b){var c=a instanceof j,d=c?a.eventObjectId:
a,e=this.groups_[d];if(!e&&b)e={},c?e.delegate=a:e.info={groupId:a,title:a},e=new this.groupClass(e),e.groupId=d,this.map_[e.eventObjectId]=e,this.groups_[d]=e,this.dispatch("datasetChanged",this,{inserted:[e]});return e},addSource:v(A),removeSource:w(A),clear:function(){G.call(this)},destroy:function(){this.destroyEmpty=!1;this.inherit();var a=Object.values(this.groups_);this.dispatch("datasetChanged",this,{deleted:a});for(var b=0;b<a.length;b++)a[b].destroy();delete this.groups_}});Basis.namespace("Basis.Data").extend({STATE:{UNDEFINED:"undefined",
READY:"ready",PROCESSING:"processing",ERROR:"error",DEPRECATED:"deprecated"},SUBSCRIPTION:{NONE:0,DELEGATE:1,COLLECTION:2,MASK:7},DataObject:j,AbstractDataset:o,Dataset:m,AggregateDataset:n,IndexedDataset:t,Collection:u,Grouping:l})})();
