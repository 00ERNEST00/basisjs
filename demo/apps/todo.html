<!doctype html>

<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />

  <title>Basis Demos: Todo list</title>

  <link rel="stylesheet" type="text/css" title="Default Style" href="../../style/style.css" media="screen" />

  <style type="text/css" id="demo-css">

    #demo-container
    {
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
    }

    #TodoListPanel
    {
      height: 100%;
      float: left;
      width: 300px;
      border-right: 3px solid #D9E8FB;
    }

    .Basis-Calendar
    {
      height: 100%;
      overflow: hidden;
      position: relative;
      width: auto;
    }

    .Basis-Calendar-Header,
    .Basis-Calendar-Footer
    {
      display: none;
    }
    .Basis-Calendar-Body
    {
      border: none;
      position: static;
    }
    .Basis-Calendar-Section
    {
      position: static;
      width: auto;
      height: auto;
    }
    .Basis-Calendar-SectionContent
    {
      position: absolute;
      top: 40px;
      bottom: 0;
      left: 0;
      right: 0;
      height: auto;
      overflow: visible;
    }
    .Basis-Calendar-MonthWeekDays
    {
      position: absolute;
      bottom: 100%;
    }
    .Basis-Calendar-MonthWeekDays-Day
    {
      width: 14.28%;
    }
    .Basis-Calendar-Section-Month .Basis-Calendar-Node
    {
      width: 14.2%;
      height: 16%;
      border-right: 1px solid #E0E0E0;
      border-bottom: 1px solid #E0E0E0;
    }

    .taskList
    {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .taskList LI
    {
      margin: 0;
      padding: 4px .5ex;
      list-style: none;
      border-bottom: 1px solid #E8E8E8;
      text-align: left;
      cursor: pointer;
    }
    .taskList LI:hover
    {
      background: #F0F0F0;
    }
    .taskList INPUT
    {
      float: right;
      margin: 2px;
      position: relative;
    }
    .taskList .date
    {
      font-size: 80%;
      padding: 2px .75ex;
      margin-right: .75ex;
      background: #F4F4F4;
      border-radius: 3px;
    }
    .taskList .IsDone
    {
      color: #888;
      text-decoration: line-through;
    }
    .Basis-Calendar-Node
    {
      padding: 0 !important;
    }
    .Basis-Calendar-Node .title
    {
      background: rgba(0,0,0,.05);
      display: block;
      padding: .25em;
    }
    .Basis-Calendar-Node LI
    {
      border: none;
      background: rgba(255,255,255,.2);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 4px;
    }
    .Basis-Calendar-Node LI:hover
    {
      background: rgba(255,255,255,.5);      
    }
    .Basis-Calendar-Node .date
    {
      display: none;
    }
    .Basis-Calendar-Node INPUT
    {
      display: none;
      margin: -1px -1px;
    }
    .Basis-Calendar-Node:hover INPUT
    {
      display: block;
    }
  </style>
  <!--[if lt IE 7]>
  <style type="text/css">
    BODY
    {
      font-size: x-small;
    }
  </style>
  <![endif]-->

  <!--[if IE 7]>
  <![endif]-->


  <script type="text/javascript" src="../../basis.js"></script>
  <script type="text/javascript" src="../../date.js"></script>
  <script type="text/javascript" src="../../data.js"></script>
  <script type="text/javascript" src="../../entity.js"></script>
  <script type="text/javascript" src="../../property.js"></script>
  <script type="text/javascript" src="../../dom_wrapper.js"></script>
  <script type="text/javascript" src="../../calendar.js"></script>
  <script type="text/javascript" src="../../locale/ru/calendar.js"></script>

  <script type="text/javascript" src="../demo.js"></script>
</head>

<body>
  <h1>Basis Demos: Todo list</h1>

  <p id="demo-summary">
    ...
  </p>
  <div id="demo-description">
    ..
  </div>

  <div id="demo-container"></div>

  <script id="demo-javascript" type="text/javascript">

    Basis.Event.onLoad(function(){
      var DOM = Basis.DOM;
      var nsData = Basis.Data;
      var nsWrapper = Basis.DOM.Wrapper;
      var nsEntity = Basis.Entity;
      var nsCalendar = Basis.Controls.Calendar;

      Task = new nsEntity.EntityType({
        name: 'Task',
        fields: {
          TaskId: nsEntity.NumberId,
          IsDone: Boolean,
          Date: Function.$self,
          Text: String
        }
      });

      var taskByDate = new nsData.Dataset.Split({
        source: Task.all,
        rule: function(task){
          return task.data.Date.toISODateString();
        }
      });

      var TaskNode = nsWrapper.TmplNode.subclass({
        template:
          '<li event-click="invertDone">' +
            '<input{idDone} type="checkbox"/>' +
            '<span class="date">{date}</span>' +
            '{text}' +
          '</li>',

        action: {
          invertDone: function(){
            this.update({
              IsDone: !this.data.IsDone
            });
          }
        },

        event_update: function(node, delta){
          nsWrapper.TmplNode.prototype.event_update.call(this, node, delta);

          this.tmpl.date.nodeValue = this.data.Date.toFormat('%D.%M.%Y');
          this.tmpl.text.nodeValue = this.data.Text;

          this.tmpl.idDone.checked = this.data.IsDone;
          Basis.CSS.classList(this.element).bool('IsDone', this.data.IsDone);
        }
      });

      var todoList = new nsWrapper.TmplContainer({
        template:
          '<div id="TodoListPanel">' +
            '<div>panel</div>' +
            '<ul{childNodesElement} class="taskList"/>' +
          '</div>',

        dataSource: Task.all,
        localSorting: Function.getter('data.Date', Number),
        childClass: TaskNode
      });

      var todoCalendar = new nsCalendar.Calendar({
        sections: null
      });
      todoCalendar.appendChild(new nsCalendar.CalendarSection.Month({
        selected: true,
        viewDate: todoCalendar.date.value,
        selectedDate: todoCalendar.selectedDate.value,
        childClass: {
          template:
            '<div{element} class="Basis-Calendar-Node" event-click="click">' +
              '<span class="title">{title}</span>' +
              '<!--{taskList}-->' +
            '</div>',

          satelliteConfig: {
            taskList: {
              dataSource: function(owner){
                return owner.data.periodStart
                  ? taskByDate.getSubset(owner.data.periodStart.toISODateString(), true)
                  : null;
              },
              instanceOf: nsWrapper.TmplContainer.subclass({
                template: 
                  '<ul class="taskList"/>',

                childClass: TaskNode
              })
            }
          }
        }
      }));

      Task.all.sync([
        { Date: new Date(2011, 07, 05), Text: 'test1' },
        { Date: new Date(2011, 07, 01), Text: 'test2', IsDone: true },
        { Date: new Date(2011, 08, 05), Text: 'test3' },
        { Date: new Date(2011, 07, 01), Text: 'test4' },
        { Date: new Date(), Text: 'test5 asd asd asdasd asdasdasd' }
      ])

      DOM.insert('demo-container', [
        todoList.element,
        todoCalendar.element
      ]);

    });

  </script>  
</body>

</html>