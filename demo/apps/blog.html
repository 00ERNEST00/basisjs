<!doctype html>

<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />

  <title>Basis Demos: Basis.js blog</title>

  <link rel="stylesheet" type="text/css" title="Default Style" href="../../style/style.css" media="screen" />

  <style type="text/css">
    HTML,
    BODY
    {
      background: #F0F0F0;
      heigh4t: 100%;
    }
    BODY
    {
      padding: 20px 0;
    }

    A
    {
      color: #06D;
    }

    #page
    {
      min-width: 600px;
      max-width: 1000px;
      margin: 0px auto 0;
      background: white;
    }
    #page-wrapper
    {
      border: 1px solid #E0E0E0;
      margin: 0 -1px;
      overflow: hidden;
    }
    #sidebar
    {
      float: right;
      height: 100%;
      width: 25%;
      min-width: 180px;
      padding: 10px;
      margin-left: 10px
    }
    #content
    {
      overflow: hidden;
      padding: 10px;
    }
    #footer
    {
      height: 2em;
    }

    .Basis-Paginator
    {
      float: right;
    }
    .Basis-Paginator .Basis-PaginatorNode
    {
      width: 4ex;
    }

    #blog-thread
    {
      clear: both;
    }
    .blog-post
    {
      margin: 1.5em 0 2em;
    }
    .blog-post__title
    {
      margin: 0;
      font-size: 160%;
      color: #2A80EE;
      font-weight: normal; 
      font-family: 'Segoe UI', Arial;
      text-decoration: underline;
      cursor: pointer;
      display: inline;
    }
    .blog-post__title:hover
    {
      color: red;
    }
    .blog-post__pubDate
    {
      font-size: 80%;
      color: #666;
      display: block;
      margin: .5em 0;
    }
    .blog-post__content
    {
      margin: .75em 0;
      color: #333;
      text-transform: capitalize;
    }
    .blog-post__footer
    {
      font-size: 90%;
      border-top: 1px solid #F8F8F8;
      padding-top: .2em;
    }
    .blog-post__category
    {
      min-width: 24ex;
      padding-right: 2ex;
      white-space: nowrap;
      float: left;
    }
    .blog-post__category-link
    {
      color: #2A80EE;
      cursor: pointer;
      text-decoration: underline;
    }
    .blog-post__tag-list .tag__title
    {
      text-decoration: underline;
      color: #2A80EE;
      cursor: pointer;
    }
    .blog-post__tag-list .tag:last-child .tag__delim
    {
      display: none;
    }

    .category-list__header,
    .archive-list__header,
    .tag-cloud__header
    {
      font-size: 140%;
      background: #2A80EE;
      color: white;
      margin: 0 -0px;
      padding: .2em 10px .3em;
      font-weight: normal;
      font-family: 'Segoe UI', Arial;
    }
    .category-list__content
    {
      margin: 0;
      padding: 1em 1ex 1em 2ex;
    }
    .category-list-item
    {
      list-style: none;
      margin: 0;
      padding: 0;
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }
    .category-list-item:hover
    {
      color: red;
    }

    .archive-list__content
    {
      padding: 1em 0 1em 16px;
      margin: 0;
    }
    .archive-list-group
    {
      list-style: none;
    }
    .archive-list-group__title
    {
      margin-left: -16px;
      padding: .2em 0 .2em 16px;
      cursor: pointer;
      background: url(arrow_down.png) no-repeat 6px center;
    }
    .archive-list-group__title:hover
    {
      background-color: #F0F0F0;
    }
    .archive-list-group__content
    {
      padding: 0 0 1em 2ex;
      margin: 0;
    }
    .archive-list-group_collapsed .archive-list-group__title
    {
      background-image: url(arrow_right.png);
      background-position: 8px center;
    }
    .archive-list-group_collapsed .archive-list-group__content
    {
      display: none;
    }
    .archive-list-item__link
    {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }
    .archive-list-item
    {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .archive-list-item__link:hover
    {
      color: red;
    }

    .tag-cloud__content
    {
      text-align: center;
      padding: 1em 0;
    }
    .cloud-tag
    {
      margin-right: 8px;
      cursor: pointer;
      -webkit-transition: font-size .5s;
    }
    .cloud-tag:hover
    {
      color: red;
    }


  </style>

  <script src="../../basis-all.js"></script>
  <script src="blog_posts-5000.js"></script>
  <script>
    basis.dom.event.onLoad(runApp = function(){
      function outStat(){
        var sdate = times.shift();

        var timelist = basis.dom.get('timelist');
        var lasttime = sdate;
        for (var i = 0; i < times.length; i++)
        {
          var t = times[i];
          timelist.appendChild(basis.dom.createElement('LI', (t[0] - sdate) + 'ms, self: ' + (t[0] - (lasttime)) + ' [' + t[1] + ']'));
          lasttime = t[0];
        }
        timelist.appendChild(basis.dom.createElement('B', lasttime - sdate))
      }

      var times = [new Date];
      BlogPost = new basis.entity.EntityType({
        name: 'BlogPost',
        fields: {
          id: basis.entity.IntId,
          pubDate: Date.fromISOString,
          title: String,
          content: String,
          category: String,
          hasCut: Boolean,
          afterCut: String,
          tags: String
        }
      });

      //console.profile();
      BlogPost.all.sync(window.rawData);
      //console.profileEnd();
      times.push([new Date, 'data load']);

      //console.profile();

      var POST_PER_PAGE = 15;

      var blogThread = new basis.data.dataset.Merge({ sources: [BlogPost.all] });
      var blogThreadPage = new basis.data.dataset.Slice({
        source: blogThread,
        limit: POST_PER_PAGE,
        rule: Function.getter('data.pubDate * -1', Number),
        listen: {
          source: {
            datasetChanged: function(source, delta){
              basis.data.dataset.Slice.prototype.listen.source.datasetChanged.call(this, source, delta);
            }
          }
        }
      });

      times.push([new Date, 'thread slice']);

      var paginator = new basis.ui.paginator.Paginator({
        container: basis.dom.get('content'),
        delegate: blogThread,
        pageCount: Math.ceil(blogThread.itemCount / POST_PER_PAGE),
        listen: {
          delegate: {
            /*sourcesChanged: {
              this.setProperties()
            },*/
            datasetChanged: function(ds){
              this.setProperties(Math.ceil(ds.itemCount / POST_PER_PAGE), 10, 0);
            }
          }
        },
        handler: {
          activePageChanged: function(){
            blogThreadPage.setRange(this.activePage * blogThreadPage.limit, blogThreadPage.limit);
          }
        }
      });

      var postList = new basis.ui.Container({
        container: basis.dom.get('content'),
        dataSource: blogThreadPage,
        localSorting: Function.getter('data.pubDate'),
        localSortingDesc: true,
        id: 'blog-thread',
        childClass: {
          template: 
            '<div class="blog-post">' +
              '<h2 class="blog-post__title">{title}</h2>' +
              '<span class="blog-post__pubDate">[#{id}] {pubDate}</span>' +
              '<div{content} class="blog-post__content"/>' +
              '<div class="blog-post__footer">' +
                '<span class="blog-post__category">Category: <span class="blog-post__category-link" event-click="filterByCategory">{category}</span></span>' +
                '<!--{taglist}-->' +
              '</div>' +
            '</div>',

          templateUpdate: function(tmpl, eventName, delta){
            tmpl.id.nodeValue = this.data.id;
            tmpl.title.nodeValue = this.data.title;
            tmpl.pubDate.nodeValue = this.data.pubDate.toFormat('%D/%M/%Y %H:%I:%S');
            tmpl.content.innerHTML = this.data.content;
            tmpl.category.nodeValue = this.data.category;
          },

          action: {
            filterByCategory: function(){
              blogThread.setSources([postByCategory.getSubset(this.data.category)]);
            }
          },

          satelliteConfig: {
            taglist: {
              existsIf: Function.getter('data.tags'),
              delegate: Function.$self,
              instanceOf: basis.ui.Container.subclass({
                template: '<div class="blog-post__tag-list">Tags: <!--{childNodesHere}--></div>',
                event_update: function(object, delta){
                  basis.ui.Container.prototype.event_update.call(this, object, delta);
                  if ('tags' in delta)
                    this.setChildNodes(this.data.tags.split(/\s*,\s*/).map(function(tag){ return { data: { title: tag }} }));
                },
                init: function(config){
                  basis.ui.Container.prototype.init.call(this, config);
                  this.setChildNodes(this.data.tags.split(/\s*,\s*/).map(function(tag){ return { data: { title: tag }} }));
                },
                childClass: basis.ui(
                  '<span class="tag"><span class="tag__title" event-click="pick">{this_data_title}</span><span class="tag__delim">, </span></span>',
                  {
                    action: {
                      pick: function(){
                        blogThread.setSources([cloud.keyMap.get(this.data.title)]);
                      }
                    }
                  }
                )
              })
            }
          }
        }
      });

      times.push([new Date, 'post list']);

      var postByCategory = new basis.data.dataset.Split({
        source: BlogPost.all,
        rule: Function.getter('data.category')
      });

      var categoryList = new basis.ui.Container({
        container: basis.dom.get('sidebar'),
        dataSource: postByCategory,
        template:
          '<div class="category-list">' +
            '<h2 class="category-list__header">Category</h2>' +
            '<ul{childNodesElement} class="category-list__content"/>' +
          '</div>',

        childClass: {
          template:
            '<li class="category-list-item" event-click="choose">{title}</li>',

          templateUpdate: function(tmpl){
            tmpl.title.nodeValue = this.data.title;
          },

          action: {
            choose: function(){
              blogThread.setSources([this.delegate]);
            }
          }
        }
      });


      times.push([new Date, 'category list']);


      var MONTH = 'January February March April May June July August September October November December'.qw();
      var archiveList = new basis.ui.Container({
        container: basis.dom.get('sidebar'),
        dataSource: new basis.data.dataset.Split({
          source: BlogPost.all,
          rule: function(post){ // Function.getter('data.pubDate.toFormat("%Y%M")')
            var date = post.data.pubDate;
            var year = date.getFullYear();
            var month = date.getMonth();
            return year + (month > 9 ? '' + month : '0' + month);
          }
        }),
        localSorting: Function.getter('data.id'),
        localSortingDesc: true,
        localGrouping: {
          groupGetter: Function.getter('data.id.substr(0,4)'),
          localSorting: Function.getter('data.id'),
          localSortingDesc: true,
          childClass: {
            template:
              '<li class="archive-list-group">' +
                '<div class="archive-list-group__title" event-click="toggle">{title}</div>' +
                '<ul{childNodesElement} class="archive-list-group__content"/>' +
              '</li>',

            templateUpdate: function(tmpl){
              tmpl.title.nodeValue = this.data.id;
            },

            action: {
              toggle: function(){
                basis.cssom.classList(this.element).toggle('archive-list-group_collapsed');
              }
            }
          }
        },
        template:
          '<div class="archive-list">' +
            '<h2 class="archive-list__header">Archive</h2>' +
            '<ul{childNodesElement} class="archive-list__content"/>' +
          '</div>',

        childClass: {
          template:
            '<li class="archive-list-item">' +
              '<span class="archive-list-item__link" event-click="choose">{title}</span> ({count})' +
            '</li>',
          templateUpdate: function(tmpl, eventName, delta){
            tmpl.title.nodeValue = MONTH[+this.data.id.substr(4, 2)] + ' ' + this.data.id.substr(0, 4)
            tmpl.count.nodeValue = this.delegate.itemCount;
          },
          action: {
            choose: function(){
              blogThread.setSources([this.delegate]);
            }
          },
          listen: {
            delegate: {
              datasetChanged: function(){
                this.tmpl.count.nodeValue = this.delegate.itemCount;
              }
            }
          }
        }
      });

      times.push([new Date, 'archive list']);

      var cloud = new basis.data.dataset.Cloud({
        source: BlogPost.all,
        rule: function(item){
          return (item.data.tags || '').split(/\s*,\s*/);
        }
      });

      var indexMap = new basis.data.index.IndexMap({
        source: cloud,
        indexes: {
          itemCountMin: new basis.data.index.Min('itemCount'),
          itemCountMax: new basis.data.index.Max('itemCount')
        },
        calcs: {
          percentOfMax: function(data, indexes, obj){
            return (obj.itemCount - indexes.itemCountMin)/(indexes.itemCountMax - indexes.itemCountMin);
          }
        },
        listen: {
          sourceObject: {
            datasetChanged: function(sourceObject){
              this.sourceMap_[sourceObject.eventObjectId].updated = true;
              this.fireUpdate();
            }
          }
        }
      });

      var tagCloud = new basis.ui.Container({
        container: basis.dom.get('sidebar'),
        id: 'tag-cloud',
        dataSource: cloud,
        localSorting: Function.getter('data.title'),
        template:
          '<div class="tag-cloud">' +
            '<h2 class="tag-cloud__header">Tags cloud</h2>' +
            '<div{childNodesElement} class="tag-cloud__content"/>' +
          '</div>',

        childClass: {
          template: 
            '<span class="cloud-tag" event-click="pick">{titleText} </span>',

          templateUpdate: function(tmpl, eventName, delta){
            tmpl.titleText.nodeValue = this.data.title;
          },

          action: {
            pick: function(){
              blogThread.setSources([this.delegate]);
            }
          },

          satelliteConfig: {
            indexes: {
              hook: { rootChanged: true, update: false },
              delegate: function(owner){
                return indexMap.getMember(owner.root);
              },
              instanceOf: basis.data.DataObject.subclass({
                active: true,
                event_update: function(object, delta){
                  basis.data.DataObject.prototype.event_update.call(this, object, delta);

                  this.owner.element.style.fontSize = '{0:.2}%'.format(80 + 120 * this.data.percentOfMax);
                }
              })
            }
          }
        }
      });

      times.push([new Date, 'tag cloud']);

      outStat();

      //console.profileEnd();

//      basis.dom.get('asd').src= 'data:text/html;plain,' + JSON.stringify(postList);
    });
  </script>
</head>

<body>
  <div id="page">
    <div id="page-wrapper">
      <!--<iframe id="asd" src="about:blank"></iframe>-->
      <button onclick="runApp()">runApp</button>
      <div id="sidebar"></div>
      <div id="content">
        <h1>Basis.js blog</h1>
        <ul id="timelist"></ul>
      </div>
    </div>
  </div>
  <div id="footer"></div>
</body>

</html>