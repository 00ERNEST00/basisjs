<!doctype html>

<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />

  <link rel="stylesheet" type="text/css" href="../../style/style.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="../../plugins/style/slider/default/style.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="../demo.css" media="screen" />

  <title>Basis Demos: Dataset</title>

  <style type="text/css" id="demo-css">
    HTML,
    BODY
    {
      font-size: small;
      font-family: Tahoma, Verdana, Arial, sans-serif;
    }

    #demo-container
    {
      font-family: Consolas;
    }

    .barWrapper
    {
      position: relative;
      text-align: right;
    }
    .bar
    {
      position: absolute;
      height: 100%;
      background: rgba(128,200,128,.5);
      right: 0;
    }
    .label
    {
      position: relative;
    }

    .diff
    {
      color: red;
    }

    .Basis-Table
    {
      margin-right: 2ex;
      float: left;
    }
    #RecordPanel
    {
      width: 250px;
      float: left;
    }
  </style>
  <!--[if lt IE 7]>
  <style type="text/css">
    BODY
    {
      font-size: x-small;
    }
  </style>
  <![endif]-->

  <!--[if IE 7]>
  <![endif]-->


  <script type="text/javascript" src="../../src/basis.js"></script>
<!--  <script type="text/javascript" src="../../data.js"></script>
  <script type="text/javascript" src="../../property.js"></script>
  <script type="text/javascript" src="../../data_index.js"></script>
  <script type="text/javascript" src="../../dom_wrapper.js"></script>
  <script type="text/javascript" src="../../table.js"></script>
  <script type="text/javascript" src="../../button.js"></script>
  <script type="text/javascript" src="../../layout.js"></script>
  <script type="text/javascript" src="../../dragdrop.js"></script>
  <script type="text/javascript" src="../../plugins/slider.js"></script>-->

  <script type="text/javascript" src="../seedrandom.js"></script>

  <script type="text/javascript" src="../demo.js"></script>
</head>

<body>
  <h1>Basic demos: Dataset</h1>
  
  <p id="demo-summary">
    ..
  </p>
  <div id="demo-description">
    ..
  </div>

  <div id="demo-container">
  </div>

  <script type="text/javascript" id="demo-javascript">

    // import names
    var DOM = basis.require('basis.dom');
    var nsData = basis.require('basis.data');
    var nsWrapper = basis.require('basis.dom.wrapper');
    var nsDataIndex = basis.require('basis.data.index');

    var ButtonPanel = basis.require('basis.ui.button').ButtonPanel;
    var Table = basis.require('basis.ui.table').Table;
    var Slider = basis.require('basis.ui.slider').Slider;
    var getter = Function.getter;

    var seed = 0;
    Math.seedrandom("basis");
    function genData(){
      seed++;
      return new basis.data.Object({
        data: {
          id: seed,
          title: 'item' + seed,
          value: parseInt(50 * Math.random()),
          total: parseInt(150 * Math.random())
        }
      });
    }

    ttt = new Date();

    var dataset = new basis.data.Dataset({
      items: Array.create(15, genData)
    });

    console.log(new Date - ttt);

    var indexMap = new nsDataIndex.IndexMap({
      source: dataset,
      indexes: {
        valueMax: new nsDataIndex.Max('data.value'),
        totalMax: new nsDataIndex.Max('data.total'),
        totalMin: new nsDataIndex.Min('data.total'),
        totalSum: new nsDataIndex.Sum('data.total')
      },
      calcs: {
        percentOfValueMax: function(data, indexes){
          return data.value/indexes.valueMax;
        },
        percentOfTotalMax: function(data, indexes){
          return (data.total - indexes.totalMin)/(indexes.totalMax - indexes.totalMin);
        },
        percentOfTotalSum: function(data, indexes){
          return data.total/indexes.totalSum;
        }
      },
      lock: function(){
        Object.values(this.indexes).forEach(function(idx){
          idx.lock();
        })
      },
      unlock: function(){
        Object.values(this.indexes).forEach(function(idx){
          idx.unlock();
        })
      }
    });

    var statPanelClass = new nsWrapper.TmplNode.subclass({
      container: DOM.get('demo-container'),
      data: Object.slice(indexMap.stat),
      templateUpdate: function(tmpl, eventName, delta){
        if (!delta) delta = {};
        DOM.insert(DOM.clear(this.element), Object.iterate(this.data, function(key, value){
          var diff = key in delta ? value - delta[key] : 0;
          return DOM.createElement(diff ? '.diff' : '', (diff ? '+' + diff + ' ' : '') + key + ': ' + value);
        }));
      },
      sync: function(){
        this.update(indexMap.stat);
      }
    });
    new statPanelClass;

    console.log(new Date - ttt);

    new ButtonPanel({
      container: DOM.get('demo-container'),
      childNodes: [
        {
          caption: 'sync',
          click: function(){
            stat.sync();
          }
        },
        {
          caption: 'add',
          click: function(){
            dataset.add([genData()]);
            stat.sync();
          }
        },
        {
          caption: 'add 5',
          click: function(){
            dataset.add(Array.create(5, genData));
            stat.sync();
          }
        },
        {
          caption: 'remove',
          click: function(){
            if (table.firstChild)
              dataset.remove([table.firstChild.root]);
            stat.sync();
          }
        },
        {
          caption: 'stress test #1',
          click: function(){
            var items = dataset.getItems();
            var t = new Date();
            var i;

            indexMap.lock();
            for (i = 0; i < 1000; i++)
            {
              var item = items[parseInt(8461 * i) % items.length];
              item.update({
                value: (item.data.value + i) % 50,
                total: (item.data.total + i) % 150
              });
            }
            indexMap.unlock();

            console.log(new Date - t);
            stat.sync();
          }
        }
      ]
    });

    var count = 0;
    var table = new Table({
      container: DOM.get('demo-container'),
      dataSource: dataset, //new basis.data.dataset.Subset({ source: dataset, rule: function(d){ return d.data.id < 50 } }),
      structure: [
        {
          header: '#',
          body: '{id}'
        },
        {
          sorting: 'data.title',
          header: 'Title',
          body: '{title}'
        },
        {
          sorting: Function.getter('data.value', Number),
          header: 'Value',
          body: '<div class="barWrapper"><div{percentOfValueMax} class="bar"/><span class="label">{value}</span></div>'
        },
        {
          sorting: Function.getter('data.total', Number),
          header: 'Total',
          body: '<div class="barWrapper"><div{percentOfTotalMax} class="bar"/><span class="label">{total}</span></div>'
        },
        {
          header: 'Total, %',
          body: '{percentOfTotalSum}'
        }
      ],

      rowBehaviour: {
        templateUpdate: function(tmpl, eventName, delta){
          if (delta)
            for (var key in delta)
              tmpl[key].nodeValue = this.data[key];
          else
            for (var key in this.data)
              if (key in tmpl)
                tmpl[key].nodeValue = this.data[key];
        }
      },
      childClass: {
        satelliteConfig: {
          indexes: {
            hook: { rootChanged: true },
            delegate: function(owner){
              return indexMap.getMember(owner.root);
            },
            instanceOf: nsData.Object.subclass({
              active: true,
              event_update: function(object, delta){
                //console.log(count++, delta);
                nsData.Object.prototype.event_update.call(this, object, delta);

                this.owner.tmpl.percentOfTotalSum.nodeValue = '{0:.2}%'.format(100 * this.data.percentOfTotalSum);
                this.owner.tmpl.percentOfTotalMax.style.width = '{0:.2}%'.format(100 * this.data.percentOfTotalMax);
                this.owner.tmpl.percentOfValueMax.style.width = '{0:.2}%'.format(100 * this.data.percentOfValueMax);
              }
            })
          }
        }
      },
      selection: {
        handler: {
          datasetChanged: function(){
            recordPanel.setDelegate(this.pick());
          }
        }
      }
    });

    var recordPanel = new nsWrapper.TmplContainer({
      container: DOM.get('demo-container'),
      id: 'RecordPanel',
      handler: {
        delegateChanged: function(){
          DOM.display(this.element, !!this.delegate);
        }
      },
      childNodes: [
        new Slider({
          autoDelegateParent: true,
          min: 0,
          max: 50,
          marks: 10,
          handler: {
            update: function(){
              if ('value' in this.data)
                this.setValue(this.data.value);
            },
            change: function(){
              this.update({ value: this.value });
            }
          }
        }),
        new Slider({
          autoDelegateParent: true,
          min: 0,
          max: 150,
          marks: 10,
          handler: {
            update: function(){
              if ('total' in this.data)
                this.setValue(this.data.total);
            },
            change: function(){
              this.update({ total: this.value });
            }
          }
        })
      ]
    });
    DOM.hide(recordPanel.element);

    var stat = new statPanelClass();
    stat.sync();
    DOM.setStyle(stat.element, {
      position: 'absolute',
      top: '10px',
      left: '300px'
    });

    console.log(new Date - ttt);

            /*indexMap.node.subclass(
              null,
              '{value}',
              function(){
                this.tmpl.value.nodeValue = '{0:.2}%'.format(100 * this.data.percentOfTotalSum);
              }
            )*/

    
  </script>
</body>

</html>
