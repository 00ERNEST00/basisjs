<!doctype html>

<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf08" />
  <title>Basis Indexes Playground</title>

  <link rel="stylesheet" type="text/css" title="Default Style" href="../style/table/vista/style.css" media="screen" />


  <script type="text/javascript" src="../basis.js"></script>
  <script type="text/javascript" src="../data.js"></script>
  <script type="text/javascript" src="../property.js"></script>
  <script type="text/javascript" src="../data_index.js"></script>
  <script type="text/javascript" src="../dom_wrapper.js"></script>
  <script type="text/javascript" src="../entity.js"></script>

  <script type="text/javascript" src="../table.js"></script>

  <style type="text/css">
    .superbar
    {
      height: 10px;
      background: #DDD;
    }
  </style>
</head>

<body>
  <div id="Layout"></div>

  <script type="text/javascript">
    var Class = Basis.Class;
    var DOM = Basis.DOM;
    
    var nsData = Basis.Data;
    var nsEntity = Basis.Entity;
    var nsWrappers = DOM.Wrapper;
    var DataObject = nsData.DataObject;
    var Dataset = nsData.Dataset;
    var Property = nsData.Property.Property;

    var MapReduce = nsData.Dataset.MapReduce;
    var KeyObjectMap = nsData.KeyObjectMap;

    var TimeEventManager = Basis.TimeEventManager;

    var Sum = nsData.Index.Sum;
    var Avg = nsData.Index.Avg;
    var Max = nsData.Index.Max;
    var Min = nsData.Index.Min;
    var Count = nsData.Index.Count; 
    var IndexMap = nsData.Index.IndexMap;

    var TmplNode = nsWrappers.TmplNode;


    var IndexObject = Class(DataObject, {
      timer_: null,

      listen: {
        index: {
          change: function(){
            this.fireApply();
          }
        }
      },
      
      event_subscribersChanged: function(object, oldCount){
        DataObject.prototype.event_subscribersChanged.call(this, object, oldCount);

        if (this.subscriberCount > 0 && oldCount == 0)
          this.fireApply();
      },

      init: function(config){
        var dataSource = this.dataSource;
        if (dataSource)
          this.dataSource = null;

        var indexes = this.indexes;
        this.indexes = {};
        if (indexes)
        {
          for (var indexName in indexes)
            this.addIndex(indexName, indexes[indexName]);
        }

        if (dataSource)
          this.setDataSource(dataSource);

        DataObject.prototype.init.call(this, config);
      },

      setDataSource: function(dataSource){
        if (dataSource instanceof nsData.AbstractDataset == false)
          dataSource = null;

        if (this.dataSource !== dataSource)
        {
          this.dataSource = dataSource;

          if (dataSource)
          {
            for (var indexName in this.indexes)
              this.indexes[indexName].setDataSource(dataSource);
          }
        }
      },

      addIndex: function(name, index){
        this.indexes[name] = index;
        index.addHandler(this.listen.index, this);

        if (this.dataSource)
          index.setDataSource(this.dataSource);
      },
      
      removeIndex: function(){
        delete this.indexes[name];
        index.removeHandler(this.listen.index, this);
      },

      fireApply: function(){
        if (!this.timer_)
        {
          this.timer_ = true;
          TimeEventManager.add(this, 'apply', Date.now());
        }
      }, 
      
      apply: function(){
        if (!this.subscriberCount)
          return; 

        var data = {};
        var newValue;
        for (var indexName in this.indexes)
        {
          newValue = this.indexes[indexName].value;
          if (this.data[indexName] !== newValue)
            data[indexName] = newValue;
        }
            
        this.update(data);

        this.timer_ = false;
      }
    });


    /////////////

    var Summary = new nsEntity.EntityType({
      fields: {
        id: nsEntity.IntId,
        error: Number,
        processing: Number,
        total: Number,
        avg: Number,
        isActive: Number
      }
    })

    var data = [
      { id:  1, error:  12, processing:  1, total: 56, avg:  5, isActive: true  },
      { id:  2, error:   2, processing:  4, total: 32, avg: 15, isActive: false },
      { id:  3, error:  32, processing:  7, total: 22, avg: 33, isActive: true  }/*,
      { id:  4, error:  44, processing:  2, total: 65, avg: 34, isActive: true },
      { id:  5, error:  12, processing:  5, total: 87, avg: 12, isActive: true },
      { id:  6, error:   3, processing:  3, total: 23, avg: 54, isActive: false },
      { id:  7, error:   5, processing:  8, total: 89, avg: 23, isActive: true },
      { id:  8, error:  45, processing: 12, total: 21, avg: 78, isActive: true },
      { id:  9, error:  11, processing:  4, total: 90, avg:  7, isActive: true },
      { id: 10, error:  10, processing:  2, total: 52, avg: 12, isActive: false },
      { id: 11, error: 152, processing:  9, total: 17, avg: 23, isActive: true },
      { id: 12, error:  54, processing:  6, total: 82, avg: 51, isActive: true },
      { id: 13, error:  15, processing:  2, total: 10, avg: 67, isActive: false },
      { id: 14, error:  32, processing:  3, total: 32, avg: 91, isActive: false },
      { id: 15, error:  33, processing:  2, total: 44, avg: 45, isActive: true }*/
    ].map(function(item){
      Summary(item)
    });


    var im = new IndexMap({
      indexes: {
        sum: new Max('data.total')
      },
      calcs: {
        percentOfMax: function(indexes, data){
          return data.data.total/ indexes.sum.value;
        }
      }
    });

    var io = new IndexObject({
      indexes: {
        error:      new Sum('data.error'),
        processing: new Sum('data.error'),
        total:      new Sum('data.total'),
        avg:        new Avg('data.avg')
      }
    });

    var control = new Basis.Controls.Table.Table({
      indexes: {
        error:      new Sum('data.error'),
        processing: new Sum('data.processing'),
        total:      new Sum('data.total'),
        avg:        new Avg('data.avg')
      },

      init: function(config){
        Basis.Controls.Table.Table.prototype.init.call(this, config);

        if (this.indexes){
          var dataset = new nsWrappers.ChildNodesDataset(this);
          for (var i in this.indexes)
            this.indexes[i].setDataSource(dataset);
        }
      },

      structure: [
        {
          header: 'id',
          body: {
            content: '{idText}'
          }
        },
        {
          header: 'error',
          body: {
            content: '{errorText}'
          },
          footer: {
            content: function(){
              return this.owner.indexes.error.addLink(DOM.createText());
            }
          }
        },
        {
          header: 'processing',
          body: {
            content: '{processingText}'
          },
          footer: {
            content: function(){
              return this.owner.indexes.processing.addLink(DOM.createText());
            }
          }
        },
        {
          header: 'total',
          body: {
            content: '{totalText}{bar}'
          },
          footer: {
            content: function(){
              return this.owner.indexes.total.addLink(DOM.createText());
            }
          }
        },
        {
          header: 'avg',
          body: {
            content: '{avgText}'
          },
          footer: {
            content: function(){
              return this.owner.indexes.avg.addLink(DOM.createText(), null, '{0:.2}');
            }
          }
        },
        {
          header: 'isActive',
          body: {
            content: '{isActiveText}'
          },
          footer: {
            content: ''
          }
        }
      ],

      /*footer: {
        delegate: io,
        active: true,
        handler: {
          update: function(object, delta){
            if ('error' in delta)
              this.tmpl.errorText.nodeValue = this.data.error;

            if ('processing' in delta)
              this.tmpl.processingText.nodeValue = this.data.processing;

            if ('total' in delta)
              this.tmpl.totalText.nodeValue = this.data.total;

            if ('avg' in delta)
              this.tmpl.avgText.nodeValue = this.data.avg;
          }
        }
      },*/

      childClass: {
        satelliteConfig: {
          bar: {
            delegate: function(owner){
              return im.getMember(owner);
            },
            instanceOf: TmplNode.subclass({
              cssClassName: 'superbar',
              active: true,
              event_update: function(object, delta){
                TmplNode.prototype.event_update.call(this, object, delta);

                if ('percentOfMax' in delta)
                  this.element.style.width = (100 * this.data.percentOfMax) + '%';
              }
            })
          }
        }
      },

      rowBehaviour: {
        event_update: function(){
          this.tmpl.idText.nodeValue = this.data.id;
          this.tmpl.errorText.nodeValue = this.data.error;
          this.tmpl.processingText.nodeValue = this.data.processing;
          this.tmpl.totalText.nodeValue = this.data.total;
          this.tmpl.avgText.nodeValue = this.data.avg;
          this.tmpl.isActiveText.nodeValue = this.data.isActive ? 'true' : 'false';
        }
      },
      container: 'Layout'
    });

    control.setDataSource(Summary.all);


    var tableData = new nsWrappers.ChildNodesDataset(control);

    im.setSource(tableData);
    io.setDataSource(tableData);



/*    new nsWrappers.TmplContainer({
      dataSource: im,
      childClass: nsWrappers(
        '<div class="row">{this_data_percentOfMax}</div>',
        {
          active: true
        }
      ),
      container: 'Layout'
    })


    var errorSum = new Sum('data.error', tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'Error Sum: ', errorSum.addLink(DOM.createText())));

    var totalSum = new Sum('data.total', tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'Total Sum: ', totalSum.addLink(DOM.createText())));

    var avgAvg = new Avg('data.avg', tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'Avg avg: ', avgAvg.addLink(DOM.createText())));

    var count = new Count(Function.$true, tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'Count: ', count.addLink(DOM.createText())));

    var isActiveCount = new Count('data.isActive', tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'isActive Count: ', isActiveCount.addLink(DOM.createText())));

    var isNotActiveCount = new Count(function(item){ return ! item.data.isActive }, tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'isNotActive Count: ', isNotActiveCount.addLink(DOM.createText())));

    var totalMax = new Max('data.total', tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'Total Max: ', totalMax.addLink(DOM.createText())));

    var totalMin = new Min('data.total', tableData);
    DOM.insert(DOM.get('Layout'), DOM.createElement('div', 'Total Min: ', totalMin.addLink(DOM.createText()))); */
    
  </script>
</body>
</html>