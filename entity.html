<!doctype html>
<script type="text/javascript" src="basis.js"></script>
<script type="text/javascript" src="data.js"></script>
<script type="text/javascript" src="entity.js"></script>
<script type="text/javascript" src="dom_wrapper.js"></script>
<style>
  .list{
    border: 1px solid red;
  }
</style>
<script>
Basis.Event.onLoad(function(){
    Function.$nullOrString = function(value){
      return value == null ? null : String(value);
    };

  with (Basis.Entity)
  {
    t1 = new EntityType({
      fields: {
        id: StringId,
        value: Number,
        square: {
          calc: CalculateField('value', function(value){
            return value * value;
          })
        },
        cube: {
          calc: CalculateField('square', 'value', function(square, value){
            if (square > 30) 
              throw 'overflow';
            else
              return square * value;
          })
        },
        a: {
          calc: CalculateField('b', function(b){
            return b;
          })
        },
        b: {
          calc: CalculateField('c', function(a){
            return a;
          })
        },
        c: {
          calc: CalculateField('a', function(a){
            return a;
          })
        }
      }
    });

    t2 = new EntityType({
      fields: {
        id: {
          type: StringId,
          calc: CalculateField('fieldId', 'wordId', function(id, value){
            return id && value ? id + '-' + value : null;
          })
        },
        fieldId: Function.$nullOrString,
        wordId: Function.$nullOrString
      }
    });

    UserGroup = new EntityType({
      fields: {
        UserGroupId: IntId,
        Title: String
      },
      aliases: {
        Id: 'UserGroupId'
      }
    });
    User = new EntityType({
      fields: {
       UserId: IntId,
       Group: UserGroup,
       Title: String
      },
      aliases: {
        Id: 'UserId',
        GroupId: 'Group'
      }
    });

    console.log(JSON.stringify(User.reader({ Id: 1, GroupId: 1, Title: 'u1', xxx: 1 })));
    console.log(JSON.stringify(User.reader({ Id: 1, Group: { Id: 2, Title: 'g1', zzz: 2 }, Title: 'u2', yy: 1 })));
  }



  new Basis.DOM.Wrapper.TmplContainer({
    container: document.body,
    dataSource: t1.all,
    cssClassName: 'list',
    childClass: Basis.DOM.Wrapper(
      '<div>#{this_data_id} {this_data_value} (square: {this_data_square}, cube: {this_data_cube})</div>'
    )
  });

  new Basis.DOM.Wrapper.TmplContainer({
    container: document.body,
    dataSource: t2.all,
    cssClassName: 'list',
    childClass: Basis.DOM.Wrapper(
      '<div>#{this_data_id} {this_data_fieldId} / {this_data_wordId}</div>'
    )
  });


  [1,2,3,4,5,6].map(function(n,i){
    t1({ id: i, value: n });
    t2({ fieldId: 1, wordId: n });
  });
})
</script>