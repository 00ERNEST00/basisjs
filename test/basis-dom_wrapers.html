<?xml version="1.0" encoding="windows-1251"?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html lang="ru" xml:lang="ru">

<head>
  <meta http-equiv="Content-type" content="text/html; charset=windows-1251" />
  <title>Basis Test Suite - DOM Wrapers</title>

  <style type="text/css">
    @import "style/default/style.css";

    /* */
    BODY
    {
      font-family: Georgia;
      font-size: small;
      _font-size: x-small;
    }
  </style>
  
  <script type="text/javascript"  src="../basis-all.js"></script>
  <script type="text/javascript"  src="test.js"></script>
  <script type="text/javascript"  src="common.js"></script>
</head>

<body>

  <script type="text/javascript">
    loadTest((function(){

      var Class = basis.Class;
      var DOM = basis.dom;
      var Data = basis.data;
      var CSS = basis.cssom;
      var Event = basis.dom.event;
      var Tester = basis.test.Tester;

      var nsWrappers = basis.dom.wrapper;
      var Property = basis.data.property.Property;
      var PropertySet = basis.data.property.DataObjectSet;

      var CookieName;
      var TestProperty;

      var updateCount = 0;

      var testSet = [
        { data: { title: 'node0', value: 0, group: 1 } },
        { data: { title: 'node1', value: 1, group: 2 } },
        { data: { title: 'node2', value: 2, group: 1 } },
        { data: { title: 'node3', value: 3, group: 3 } },
        { data: { title: 'node4', value: 4, group: 4 } },
        { data: { title: 'node5', value: 5, group: 2 } },
        { data: { title: 'node6', value: 6, group: 2 } },
        { data: { title: 'node7', value: 7, group: 1 } },
        { data: { title: 'node8', value: 8, group: 3 } },
        { data: { title: 'node9', value: 9, group: 1 } }
      ];

      var convertToNode = Function.getter(Function.$self, testSet);

      function getTestSet(){
        return testSet.map(function(item){
          return {
            data: Object.slice(item.data)
          }
        });
      }

      function nodeFactory(cfg){
        return new nsWrappers.Node(cfg);
      };

      function getGroups(node, withNull){
        var res = Array.from(node.localGrouping.childNodes);
        if (withNull)
          res.unshift(node.localGrouping.nullGroup);
        return res;
      }

      function checkOrder(nodes, host){
        var sortingValue = host.localSorting;
        var desc = host.localSortingDesc;

        for (var i = 0; i < nodes.length; i++)
          if (nodes[i].sortingValue !== sortingValue(nodes[i]))
            return 'Bad sortingValue';

        if (!desc)
        {
          for (var i = 0; i < nodes.length - 1; i++)
            if (nodes[i].sortingValue > nodes[i + 1].sortingValue)
              return 'Wrong order';
        }
        else
        {
          for (var i = 0; i < nodes.length - 1; i++)
            if (nodes[i].sortingValue < nodes[i + 1].sortingValue)
              return 'Wrong order';
        }
      }

      function checkNode(node){
        var res;

        if (node.childNodes)
        {
          var childCount = node.childNodes.length;

          if (node.firstChild !== (node.childNodes[0] || null))
            return 'Wrong firstChild ref';
          if (node.lastChild !== (node.childNodes[childCount - 1] || null))
            return 'Wrong lastChild ref';

          for (var i = 0; i < childCount; i++)
          {
            child = node.childNodes[i];
            if (child.parentNode !== node)
              return 'child #' + i + ' has wrong parentNode ref';
            if (child.previousSibling !== (node.childNodes[i - 1] || null))
              return 'child #' + i + ' has wrong previousSibling ref';
            if (child.nextSibling !== (node.childNodes[i + 1] || null))
              return 'child #' + i + ' has wrong nextSibling ref';
            //if (child.document != node.document)
            //  return 'child #' + i + ' has wrong document ref';
          }

          if (node.localSorting)
          {
            if (node.localGrouping)
            {
              var groups = getGroups(node, true);
              for (var i = 0; i < groups.length; i++)
                if (res = checkOrder(groups[i].nodes, node))
                  return 'Sorting in group: ' + res;
            }
            else
              if (res = checkOrder(node.childNodes, node))
                return 'Sorting: ' + res;
          }

          if (node.localGrouping)
          {
            if (res = checkNode(node.localGrouping))
              return res;

            var groups = getGroups(node, true);
            for (var i = 0; i < groups.length; i++)
            {
              if (res = checkNode(groups[i]))
                return 'group #' + i + ': ' + res;
            }
          }
        }
        else
        {
          if (node.firstChild)
            return 'Wrong firstChild ref';
          if (node.lastChild)
            return 'Wrong lastChild ref';
        }

        if (node instanceof nsWrappers.GroupingNode)
        {
          if (node.owner && node.owner.localGrouping !== node)
              return 'wrong GroupingNode.owner ref';
        }

        if (node instanceof nsWrappers.PartitionNode)
        {
          if (node.nodes)
          {
            var nodeCount = node.nodes.length;

            if (node.first !== (node.nodes[0] || null))
              return 'wrong PartitionNode.first ref';
            if (node.last !== (node.nodes[nodeCount - 1] || null))
              return 'wrong PartitionNode.last ref';

            if (node.first)
            {
              var hostNode = node.first.parentNode;
              var childNodesIndex = hostNode.childNodes.indexOf(node.first);
              for (var i = 0; i < node.nodes.length; i++)
                if (node.nodes[i] !== hostNode.childNodes[childNodesIndex + i])
                  return 'wrong PartitionNode.nodes order';
            }
          }
        }

        return false;
      }

      function $values(ar){
        return ar.map(function(node){
          return node.data.value + '(' + node.data.group + ')';
        })
      }

      return [
        {
          name: 'Property',
          testcase: [
            {
              name: 'create',
              test: function(){
                TestProperty = new Property(123);
                this.is(123, TestProperty.value);
              }
            },
            {
              name: 'addLink/removeLink',
              test: function(){


              }
            },
            {
              name: 'set #1',
              test: function(){
                var t = {};
                var value = Math.random();

                TestProperty.addLink(t, 'saved');
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value, t.saved);

                // not fire on existing value set
                t.saved = 0;
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(0, t.saved);

                // fire on existing value set, with forced flag
                t.saved = 0;
                TestProperty.set(value, true);
                this.is(value, TestProperty.value);
                this.is(value, t.saved);

                TestProperty.clear();
              }
            },
            {
              name: 'set #2',
              test: function(){
                var t = {};
                var value = Math.random();
                TestProperty.addLink(t, 'saved');
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value, t.saved);
                TestProperty.clear();

                var t = {};
                var value = Math.random();
                TestProperty.addLink(t, 'saved', '{0:.2}');
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value.toFixed(2), t.saved);
                TestProperty.clear();

                var t = {};
                var value = Math.random();
                TestProperty.addLink(t, function(value){ this.saved = value * 2 });
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value * 2, t.saved);
                TestProperty.clear();
              }
            },
            {
              name: 'set #3',
              test: function(){
                var t = DOM.createElement('DIV');
                var value = Math.random();
                TestProperty.addLink(t);
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(String(value), t.innerHTML);
                TestProperty.clear();

                var t = DOM.createElement('DIV');
                var value = Math.random();
                TestProperty.addLink(t, 'title');
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(String(value), t.title);
                TestProperty.clear();

                var t = DOM.createText('#text');
                var value = Math.random();
                TestProperty.addLink(t);
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(String(value), t.nodeValue);
                TestProperty.clear();

                var t = DOM.createText('#text');
                var value = Math.random();
                TestProperty.addLink(t, null, '{0:.2}');
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value.toFixed(2), t.nodeValue);
                TestProperty.clear();
              }
            },
            {
              name: 'get',
              test: function(){
              }
            }/*,
            {
              name: 'Property with proxy',
              test: function(){
                var a = new Property(0, null, Data.validator(function(value){ return !isNaN(value) && value }));
                a.set(3);
                this.is(3, a.value);
                a.set('hello');
                this.is(3, a.value);
              }
            }*/
          ]
        },
        {
          name: 'PropertySet',
          testcase: [
            {
              name: 'test #1',
              test: function(){
                s = new PropertySet();
                s.a = new Property(1);
                s.b = new Property(2);

                updateCount = 0;
                s.add(s.a);
                s.add(s.b);

                s.addHandler({
                  change: function(){
                    updateCount++;
                  }
                });

                s.a.set(11);
                s.b.set(11);

                this.is(0,0); // WTF?

                s.a.set('test');
              }
            },
            {
              name: 'checkout',
              test: function(){
                this.is(1, updateCount);
                this.is('test', s.a.value);
                this.is(11, s.b.value);
              }
            },
            {
              name: 'destroyed property unlink',
              test: function(){
                s = new PropertySet();
                s.a = new Property(1);
                s.b = new Property(2);

                updateCount = 0;
                s.add(s.a);
                s.add(s.b);

                s.addHandler({
                  change: function(){
                    updateCount++;
                  }
                });

                this.is(2, s.objects.length);
                this.is(0, updateCount);

                s.a.destroy();

                this.is(1, s.objects.length);
                this.is(0, updateCount);
              }
            },
            {
              name: 'destroyed PropertySet unlink',
              test: function(){
                var result = 0;
                s = new PropertySet();
                s.a = new Property(1),
                s.b = new Property(2);

                s.addHandler({
                  change: function(){
                    result = a.value + b.value;
                  }
                });

                s.a.destroy();

                this.is(0, result);
              }
            }
          ]
        },
        {
          name: 'DOM wrappers',
          testcase: [
            {
              name: 'basic',
              testcase: [
                {
                  name: 'create',
                  test: function(){
                    var node = new nsWrappers.Node();
                    this.is(false, checkNode(node));

                    var node = new nsWrappers.Node({ data: { a: 1, b: 2 } });
                    this.is({ a: 1, b: 2}, node.data);
                  }
                },
                {
                  name: 'create with childNodes',
                  test: function(){
                    var testSet = getTestSet();
                    var node = new nsWrappers.Node({ childNodes: testSet.map(nodeFactory) });
                    this.is(false, checkNode(node));
                    this.is(testSet.length, node.childNodes.length);
                    this.is($values(testSet), $values(node.childNodes));

                    var testSet = getTestSet();
                    var node = new nsWrappers.Node({ childFactory: nodeFactory, childNodes: testSet });
                    this.is(false, checkNode(node));
                    this.is(testSet.length, node.childNodes.length);
                    this.is($values(testSet), $values(node.childNodes));
                  }
                },
                {
                  name: 'appendChild',
                  test: function(){
                    var node = new nsWrappers.Node();
                    var testSet = getTestSet();
                    for (var i = 0; i < testSet.length; i++)
                      node.appendChild(new nsWrappers.Node(testSet[i]));
                    this.is(false, checkNode(node));
                    this.is(testSet.length, node.childNodes.length);
                    this.is($values(testSet), $values(node.childNodes));
                  }
                },
                {
                  name: 'insertBefore',
                  test: function(){
                    var testSet = getTestSet();
                    var node = new nsWrappers.Node();
                    for (var i = 0; i < testSet.length; i++)
                      node.insertBefore(new nsWrappers.Node(testSet[i]));

                    this.is(false, checkNode(node));
                    this.is(testSet.length, node.childNodes.length);
                    this.is($values(testSet), $values(node.childNodes));

                    var testSet = getTestSet();
                    var node = new nsWrappers.Node();
                    for (var i = 0; i < testSet.length; i++)
                      node.insertBefore(new nsWrappers.Node(testSet[i]), node.firstChild);

                    this.is(false, checkNode(node));
                    this.is(testSet.length, node.childNodes.length);
                    this.is($values(testSet).reverse(), $values(node.childNodes));
                  }
                },
                {
                  name: 'DOM.insert',
                  test: function(){
                    var testSet = getTestSet();
                    var node = new nsWrappers.Node();
                    DOM.insert(node, testSet.map(nodeFactory))
                    this.is(false, checkNode(node));
                    this.is(testSet.length, node.childNodes.length);
                    this.is($values(testSet), $values(node.childNodes));

                    var testSet = getTestSet();
                    var node = new nsWrappers.Node({ childFactory: nodeFactory });
                    DOM.insert(node, testSet)
                    this.is(false, checkNode(node));
                    this.is(testSet.length, node.childNodes.length);
                    this.is($values(testSet), $values(node.childNodes));
                  }
                }
              ]
            },
            {
              name: 'localSorting',
              testcase: []
            },
            {
              name: 'localGrouping',
              testcase: [
                {
                  name: 'localGrouping in config',
                  test: function(){
                    var testSet = getTestSet();
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localGrouping: 'data.group'
                    });

                    for (var i = 0; i < testSet.length; i++)
                      node.appendChild(testSet[i]);

                    this.is(false, checkNode(node));
                    this.is($values(testSet.sortAsObject('data.group')), $values(node.childNodes));

                    // =======================================
                    var testSet = getTestSet();
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localGrouping: {
                        groupGetter: Function.getter('data.group'),
                        localSorting: Function.getter('data.id'),
                        localSortingDesc: true
                      }
                    });

                    for (var i = 0; i < testSet.length; i++)
                      node.appendChild(testSet[i]);

                    this.is(false, checkNode(node));
                    this.is($values([4, 3, 8, 1, 5, 6, 0, 2, 7, 9].map(convertToNode)), $values(node.childNodes));

                    // ======================================
                    var testSet = getTestSet();
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      localSortingDesc: true,
                      localGrouping: {
                        groupGetter: Function.getter('data.group'),
                        localSorting: Function.getter('data.id'),
                        localSortingDesc: true
                      },
                      childNodes: testSet
                    });

                    this.is(false, checkNode(node));
                    this.is($values([4, 8, 3, 6, 5, 1, 9, 7, 2, 0].map(convertToNode)), $values(node.childNodes));
                  }
                },
                {
                  name: 'update PartitionNode',
                  test: function(){
                    // ======================================
                    var testSet = getTestSet();
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      localSortingDesc: true,
                      localGrouping: {
                        groupGetter: Function.getter('data.group'),
                        localSorting: Function.getter('data.title', String),
                        localSortingDesc: true
                      },
                      childNodes: testSet
                    });

                    this.is(false, checkNode(node));
                    this.is($values([4, 8, 3, 6, 5, 1, 9, 7, 2, 0].map(convertToNode)), $values(node.childNodes));

                    var groups = getGroups(node);
                    for (var i = 0; i < groups.length; i++)
                      groups[i].update({ title: 'group' + groups[i].data.title });

                    this.is(false, checkNode(node));
                    this.is($values([4, 8, 3, 6, 5, 1, 9, 7, 2, 0].map(convertToNode)), $values(node.childNodes));

                    groups[0].update({ title: '-1' });
                    this.is(false, checkNode(node));
                    this.is($values([8, 3, 6, 5, 1, 9, 7, 2, 0, 4].map(convertToNode)), $values(node.childNodes));

                    groups[1].update({ title: '-2' });
                    this.is(false, checkNode(node));
                    this.is($values([6, 5, 1, 9, 7, 2, 0, 8, 3, 4].map(convertToNode)), $values(node.childNodes));

                    groups[2].update({ title: '-3' });
                    this.is(false, checkNode(node));
                    this.is($values([9, 7, 2, 0, 6, 5, 1, 8, 3, 4].map(convertToNode)), $values(node.childNodes));

                    groups[3].update({ title: '-4' });
                    this.is(false, checkNode(node));
                    this.is($values([9, 7, 2, 0, 6, 5, 1, 8, 3, 4].map(convertToNode)), $values(node.childNodes));
                  }
                },
                {
                  name: 'update PartitionNode with delegate',
                  test: function(){
                    var groupNodes = {};
                    for (var i = 1; i <= 4; i++)
                      groupNodes[i] = new nsWrappers.Node({
                        data: {
                          title: i
                        }
                      });

                    // ======================================
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      localSortingDesc: true,
                      localGrouping: {
                        groupGetter: Function.getter('data.group', groupNodes),
                        localSorting: Function.getter('data.title'),
                        localSortingDesc: true
                      },
                      childNodes: testSet//.filter(Function.getter('data.group >= 3'))
                    });

                    this.is(false, checkNode(node));
                    this.is(4, getGroups(node).length);
                    this.is($values([4, 8, 3, 6, 5, 1, 9, 7, 2, 0].map(convertToNode)), $values(node.childNodes));

                    var groups = getGroups(node);
                    /*for (var i = 0; i < groups.length; i++)
                      groups[i].update({ title: 'group' + i });*/

                    groups[0].update({ title: -4 });
                    this.is(false, checkNode(node));
                    this.is($values([8, 3, 6, 5, 1, 9, 7, 2, 0, 4].map(convertToNode)), $values(node.childNodes));

                    groups[1].update({ title: -3 });
                    this.is(false, checkNode(node));
                    this.is($values([6, 5, 1, 9, 7, 2, 0, 8, 3, 4].map(convertToNode)), $values(node.childNodes));

                    groups[2].update({ title: -2 });
                    this.is(false, checkNode(node));
                    this.is($values([9, 7, 2, 0, 6, 5, 1, 8, 3, 4].map(convertToNode)), $values(node.childNodes));

                    groups[3].update({ title: -1 });
                    this.is(false, checkNode(node));
                    this.is($values([9, 7, 2, 0, 6, 5, 1, 8, 3, 4].map(convertToNode)), $values(node.childNodes));

                  }
                },
                {
                  name: 'setLocalGrouping after create and update PartitionNode with delegate',
                  test: function(){

                    var groupNodes = {};
                    for (var i = 1; i <= 4; i++)
                      groupNodes[i] = new nsWrappers.Node({
                        data: {
                          title: i
                        }
                      });


                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      localSortingDesc: true,
                      childNodes: testSet//.filter(Function.getter('data.group >= 3'))
                    });

                    this.is(false, checkNode(node));

                    node.setLocalGrouping({
                      groupGetter: Function.getter('data.group', groupNodes),
                      localSorting: Function.getter('data.title'),
                      localSortingDesc: true
                    });

                    this.is(false, checkNode(node));
                    this.is(4, getGroups(node).length);
                    this.is($values([4, 8, 3, 6, 5, 1, 9, 7, 2, 0].map(convertToNode)), $values(node.childNodes));

                    var groups = getGroups(node);
                    /*for (var i = 0; i < groups.length; i++)
                      groups[i].update({ title: 'group' + i });*/

                    groups[0].update({ title: -4 });
                    this.is(false, checkNode(node));
                    this.is($values([8, 3, 6, 5, 1, 9, 7, 2, 0, 4].map(convertToNode)), $values(node.childNodes));

                    groups[1].update({ title: -3 });
                    this.is(false, checkNode(node));
                    this.is($values([6, 5, 1, 9, 7, 2, 0, 8, 3, 4].map(convertToNode)), $values(node.childNodes));

                    groups[2].update({ title: -2 });
                    this.is(false, checkNode(node));
                    this.is($values([9, 7, 2, 0, 6, 5, 1, 8, 3, 4].map(convertToNode)), $values(node.childNodes));

                    groups[3].update({ title: -1 });
                    this.is(false, checkNode(node));
                    this.is($values([9, 7, 2, 0, 6, 5, 1, 8, 3, 4].map(convertToNode)), $values(node.childNodes));
                  }
                },
                {
                  name: 'setLocalGrouping after create and update PartitionNode with delegate & subscription',
                  test: function(){

                    var groupDelegateClass = Class(nsWrappers.Node, {
                      event_subscribersChanged: function(obj){
                        nsWrappers.Node.prototype.event_subscribersChanged.call(this, obj);
                        if (this.subscriberCount)
                          this.update({ title: this.data.title_ });
                      }
                    })

                    var groupNodes = {};
                    for (var i = 1; i <= 4; i++)
                      groupNodes[i] = new groupDelegateClass({
                        data: {
                          title_: -i,
                          title: i
                        }
                      });


                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      localSortingDesc: true,
                      localGroupingClass: {
                        childClass: {
                          active: true
                        }
                      },
                      childNodes: testSet//.filter(Function.getter('data.group >= 3'))
                    });

                    this.is(false, checkNode(node));

                    node.setLocalGrouping({
                      groupGetter: Function.getter('data.group', groupNodes),
                      localSorting: Function.getter('data.title'),
                      localSortingDesc: true
                    });

                    this.is(false, checkNode(node));
                    this.is(4, getGroups(node).length);
                    this.is($values([9, 7, 2, 0, 6, 5, 1, 8, 3, 4].map(convertToNode)), $values(node.childNodes));
                  }
                }
              ]
            },
            {
              name: 'Dynamic test',
              testcase: [
                {
                  name: 'set sorting',
                  test: function(){
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      childNodes: getTestSet()
                    });

                    this.is(false, checkNode(node));

                    node.setLocalSorting(Function.getter('data.value'));
                    this.is(false, checkNode(node));

                    var order = Array.from(node.childNodes);
                    node.setLocalSorting(Function.getter('data.value * -1'), true);
                    this.is(false, checkNode(node));
                    this.is(order, node.childNodes);

                    node.setLocalSorting();
                    this.is(false, checkNode(node));

                    node.setLocalSorting(Function.getter('data.value'), true);
                    this.is(false, checkNode(node));

                    var order = Array.from(node.childNodes);
                    for (var i = 0; i < order.length; i++)
                      order[i].update({ value: -order[i].data.value });
                    this.is(false, checkNode(node));
                    this.is(order.reverse(), node.childNodes);
                  },
                },
                {
                  name: 'set sorting #2',
                  test: function(){
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      childNodes: getTestSet()
                    });
                    this.is(false, checkNode(node));

                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      localSortingDesc: true,
                      childNodes: getTestSet()
                    });
                    this.is(false, checkNode(node));

                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localSorting: Function.getter('data.value'),
                      localSortingDesc: true
                    });
                    this.is(false, checkNode(node));
                    node.setChildNodes(getTestSet());
                    this.is(false, checkNode(node));
                    node.clear();
                    this.is(false, checkNode(node));
                    node.setChildNodes(getTestSet());
                    this.is(false, checkNode(node));
                  }
                },
                {
                  name: 'set grouping',
                  test: function(){
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      childNodes: getTestSet()
                    });
                    this.is(false, checkNode(node));

                    node.setLocalGrouping(Function.getter('data.group'));
                    this.is(false, checkNode(node));
                    this.is(4, getGroups(node).length);

                    // change grouping
                    node.setLocalGrouping(Function.getter('data.value'));
                    this.is(false, checkNode(node));
                    this.is(10, getGroups(node).length);

                    // drop grouping
                    var order = Array.from(node.childNodes);
                    node.setLocalGrouping();
                    this.is(false, checkNode(node));
                    this.is(null, node.localGrouping);
                    this.is(order, node.childNodes);

                    node.setLocalGrouping({
                      groupGetter: Function.getter('data.value'),
                      localSorting: Function.getter('data.title')
                    });
                    this.is(false, checkNode(node));

                    var order = Array.from(node.childNodes);
                    // nothing changed
                    node.localGrouping.setLocalSorting(node.localGrouping.localSorting);
                    this.is(false, checkNode(node));
                    this.is(order, node.childNodes);
                    // reverse order
                    node.localGrouping.setLocalSorting(node.localGrouping.localSorting, true);
                    this.is(false, checkNode(node));
                    this.is(order.reverse(), node.childNodes);
                  }
                },
                {
                  name: 'set grouping #2',
                  test: function(){
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localGrouping: {
                        groupGetter: Function.getter('data.value')
                      }
                    });
                    this.is(false, checkNode(node));
                    node.setChildNodes(getTestSet());
                    this.is(false, checkNode(node));
                    node.clear();
                    this.is(false, checkNode(node));
                    node.setChildNodes(getTestSet());
                    this.is(false, checkNode(node));
                  }
                },
                {
                  name: 'nesting grouping',
                  test: function(){
                    // 1 set, remove one by one, and add one by one
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localGrouping: {
                        groupGetter: Function.getter('data.value'),
                        localGrouping: {
                          groupGetter: Function.getter('data.id % 4'),
                          localGrouping: Function.getter('data.id % 2')
                        }
                      },
                      childNodes: getTestSet()
                    });

                    this.is(false, checkNode(node));
                    node.localGrouping.localGrouping.setLocalGrouping();
                    this.is(false, checkNode(node));
                    node.localGrouping.setLocalGrouping();
                    this.is(false, checkNode(node));
                    node.setLocalGrouping();
                    this.is(false, checkNode(node));
                    node.setLocalGrouping('data.value');
                    this.is(false, checkNode(node));
                    node.localGrouping.setLocalGrouping('data.id % 4');
                    this.is(false, checkNode(node));
                    node.localGrouping.localGrouping.setLocalGrouping('data.id % 2');
                    this.is(false, checkNode(node));

                    // 2 set child node after all

                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      localGrouping: {
                        groupGetter: Function.getter('data.value'),
                        localGrouping: {
                          groupGetter: Function.getter('data.id % 4'),
                          localGrouping: Function.getter('data.id % 2')
                        }
                      }
                    });
                    node.setChildNodes(getTestSet());
                    this.is(false, checkNode(node));
                    node.setLocalGrouping();
                    this.is(false, checkNode(node));

                    // 3 increase grouping and drop

                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      childNodes: getTestSet()
                    });
                    this.is(false, checkNode(node));
                    node.setLocalGrouping('data.value');
                    this.is(false, checkNode(node));
                    node.localGrouping.setLocalGrouping('data.id % 4');
                    this.is(false, checkNode(node));
                    node.localGrouping.localGrouping.setLocalGrouping('data.id % 2');
                    this.is(false, checkNode(node));
                    node.setLocalGrouping();
                    this.is(false, checkNode(node));

                    // 4 set nested grouping

                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      childNodes: getTestSet()
                    });
                    node.setLocalGrouping({
                      groupGetter: Function.getter('data.value'),
                      localGrouping: {
                        groupGetter: Function.getter('data.id % 4'),
                        localGrouping: Function.getter('data.id % 2')
                      }
                    });
                    this.is(false, checkNode(node));
                    node.setLocalGrouping('data.value');
                    this.is(true, node.localGrouping != null);
                    node.setLocalGrouping({
                      groupGetter: Function.getter('data.value'),
                      localGrouping: {
                        groupGetter: Function.getter('data.id % 4'),
                        localGrouping: Function.getter('data.id % 2')
                      }
                    });
                    this.is(false, checkNode(node));
                    node.setLocalGrouping();
                    this.is(false, checkNode(node));
                  }
                },
                {
                  name: 'mixing sorting & grouping',
                  test: function(){
                    var node = new nsWrappers.Node({
                      childFactory: nodeFactory,
                      childNodes: getTestSet()
                    });

                    node.setLocalGrouping(Function.getter('data.group'));
                    this.is(false, checkNode(node));

                    node.setLocalSorting(Function.getter('data.value'));
                    this.is(false, checkNode(node));

                    node.setLocalGrouping({
                      groupGetter: Function.getter('data.group'),
                      localSorting: Function.getter('data.id'),
                      localSortingDesc: true
                    });
                    this.is(false, checkNode(node));

                    node.setLocalGrouping();
                    this.is(false, checkNode(node));

                    node.setLocalSorting(Function.getter('data.group'), true);
                    this.is(false, checkNode(node));

                    node.setLocalGrouping(Function.getter('data.group'));
                    this.is(false, checkNode(node));

                    var order = Array.from(node.childNodes);
                    node.setLocalSorting();
                    this.is(false, checkNode(node));
                    node.setLocalGrouping();
                    this.is(false, checkNode(node));
                    this.is(order, node.childNodes);
                  }
                }
              ]
            }
          ]
        }
      ];

    })());


  </script>
</body>

</html>