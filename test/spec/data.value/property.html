<!doctype html>

<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <title>Basis Test Suite - basis.data.value</title>

  <style type="text/css">
    @import "../../style/style.css";

    /* */
    BODY
    {
      font-family: Georgia;
      font-size: small;
      _font-size: x-small;
    }
  </style>
  
  <script type="text/javascript" data-basis-config="" src="../../../src/basis.js"></script>
  <script type="text/javascript" src="../../test.js"></script>
  <script type="text/javascript" src="../../common.js"></script>
</head>

<body>

  <script type="text/javascript">
    loadTest((function(){

      var DOM = basis.dom;

      var Property = basis.data.value.Property;
      var PropertySet = basis.data.value.ObjectSet;

      var TestProperty;

      var updateCount = 0;
      var s;

      return [
        {
          name: 'basis.data.Value',
          testcase: [
            {
              name: 'Value#as',
              test: function(){
                var value = new basis.data.Value();
                var fn = function(){};
                var a = value.as(fn);
                var b = value.as(fn);

                this.is(true, a instanceof basis.Token);
                this.is(true, a === b);

                ///////

                var value = new basis.data.Value();
                var fn = function(){};
                var a = value.as(fn, true);
                var b = value.as(fn, true);

                this.is(true, a instanceof basis.DeferredToken);
                this.is(true, a === b);

                ///////

                var value = new basis.data.Value();
                var a = value.as(function(){});
                var b = value.as(function(){});

                this.is(true, a instanceof basis.Token);
                this.is(true, a === b);

                ///////

                var value = new basis.data.Value({ value: 3 });
                var fn = function(v){ return v * v };
                var a = value.as(fn);
                var b = value.as(basis.fn.$self);

                this.is(true, a !== b);
                this.is(9, a.value);
                this.is(3, b.value);

                value.set(4);

                this.is(16, a.value);
                this.is(4, b.value);
              }
            }
          ]
        },
        {
          name: 'Property',
          testcase: [
            {
              name: 'create',
              test: function(){
                TestProperty = new Property(123);
                this.is(123, TestProperty.value);
              }
            },
            {
              name: 'link/unlink',
              test: function(){
                var p = new Property(1);
                var o = new basis.data.Object({
                  setXXX: function(value){
                    this.xxx = value;
                  }
                });

                this.is(null, p.links_);
                this.is(null, o.handler);
                
                p.link(o, o.setXXX);
                this.is(1, o.xxx);
                this.is(true, o.handler !== null);
                this.is(true, p.links_.context === o);
                this.is(null, p.links_.links_);

                p.unlink(o);
                this.is(null, o.handler);
                this.is(null, p.links_);

                p.link(o, o.setXXX);
                p.link(o, function(value){ this.xxx = value });
                this.is(true, p.links_.context === o);
              }
            },
            {
              name: 'linked value and emitter should correct reset links',
              test: function(){
                // destroy linked object
                var p = new Property(1);
                var o = new basis.data.Object();
                p.link(o, function(){});
                this.is(true, !!o.handler);
                this.is(true, !!p.links_);

                o.destroy();
                this.is(null, o.handler);
                this.is(null, p.links_);

                // destroy value with link to emitter
                var p = new Property(1);
                var o = new basis.data.Object();
                p.link(o, function(){});

                p.destroy();
                this.is(null, o.handler);
                this.is(null, p.links_);
              }
            },
            {
              name: 'set #1',
              test: function(){
                var TestProperty = new Property(123);
                var t = {};
                var value = Math.random();

                TestProperty.link(t, 'saved');
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value, t.saved);

                // not fire on existing value set
                t.saved = 0;
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(0, t.saved);

                TestProperty.destroy();
              }
            },
            {
              name: 'set #2',
              test: function(){
                var TestProperty = new Property(123);
                var t = {};
                var value = Math.random();
                TestProperty.link(t, 'saved');
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value, t.saved);
                TestProperty.destroy();

                var TestProperty = new Property(123);
                var t = {};
                var value = Math.random();
                TestProperty.link(t, function(value){ this.saved = value * 2; });
                TestProperty.set(value);
                this.is(value, TestProperty.value);
                this.is(value * 2, t.saved);
                TestProperty.destroy();
              }
            },
            {
              name: 'get',
              test: function(){
              }
            }/*,
            {
              name: 'Property with proxy',
              test: function(){
                var a = new Property(0, null, Data.validator(function(value){ return !isNaN(value) && value }));
                a.set(3);
                this.is(3, a.value);
                a.set('hello');
                this.is(3, a.value);
              }
            }*/
          ]
        },
        {
          name: 'PropertySet',
          testcase: [
            {
              name: 'test #1',
              test: function(){
                s = new PropertySet();
                s.a = new Property(1);
                s.b = new Property(2);

                updateCount = 0;
                s.add(s.a);
                s.add(s.b);

                s.addHandler({
                  change: function(){
                    updateCount++;
                  }
                });

                s.a.set(11);
                s.b.set(11);

                s.a.set('test');
              }
            },
            {
              name: 'checkout',
              test: function(){
                // this checks here because PropertySet update occur by timeout
                this.is(1, updateCount);
                this.is('test', s.a.value);
                this.is(11, s.b.value);
              }
            },
            {
              name: 'destroyed property unlink',
              test: function(){
                var s = new PropertySet();
                s.a = new Property(1);
                s.b = new Property(2);

                var updateCount = 0;
                s.add(s.a);
                s.add(s.b);

                s.addHandler({
                  change: function(){
                    updateCount++;
                  }
                });

                this.is(2, s.objects.length);
                this.is(0, updateCount);

                s.a.destroy();

                this.is(1, s.objects.length);
                this.is(0, updateCount);
              }
            },
            {
              name: 'destroyed PropertySet unlink',
              test: function(){
                var result = 0;
                var s = new PropertySet();
                s.a = new Property(1),
                s.b = new Property(2);

                s.addHandler({
                  change: function(){
                    result = a.value + b.value;
                  }
                });

                s.a.destroy();

                this.is(0, result);
              }
            }
          ]
        }
      ];

    })());


  </script>
</body>

</html>