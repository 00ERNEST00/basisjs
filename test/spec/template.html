<!doctype html>

<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <title>Basis Test Suite - Template</title>

  <style type="text/css">
    @import "../style/style.css";

    /* */
    BODY
    {
      font-family: Georgia;
      font-size: small;
      _font-size: x-small;
    }
  </style>

  <script>
    var __resources__ = {
      'foo/1.tmpl': '<b:resource src="1.css"/>',
      'foo/1.css': '',
      'foo/custom/2.tmpl': '<b:resource src="2.css"/>',
      'foo/custom/2.css': ''
    };
  </script>
  
  <script type="text/javascript" data-basis-config src="../../src/basis.js"></script>
  <script type="text/javascript" src="../test.js"></script>
  <script type="text/javascript" src="../common.js"></script>
</head>

<body>
  <script type="text/javascript">
    loadTest((function(){
      basis.require('basis.dom');
      basis.require('basis.template.html');

      var createTemplate = function(source){
        return new basis.template.html.Template(source);
      }

      var text = function(template, binding){
        if (typeof template == 'string')
          template = createTemplate(template);

        var tmpl = template.createInstance();
        if (binding)
          for (var key in binding)
            tmpl.set(key, binding[key]);

        var fragment = tmpl.element.parentNode;
        var cursor = fragment.firstChild;
        var res = '';
        while (cursor)
        {
          res += basis.dom.outerHTML(cursor);
          cursor = cursor.nextSibling;
        }

        return res;
      }

      return [
        {
          name: 'Source',
          testcase: [
            {
              name: 'Path resolving',
              testcase: [
                {
                  name: 'Template baseURI on theme change, when templates on different locations',
                  test: function(){
                    basis.template.theme('base').define('test', basis.resource('foo/1.tmpl'));
                    basis.template.theme('custom').define('test', basis.resource('foo/custom/2.tmpl'));
                    basis.template.setTheme('base');
                    
                    var tmpl = new basis.template.html.Template(basis.template.get('test'));
                    tmpl.getBinding({});
                    this.is(1, tmpl.resources.length);
                    this.is(basis.path.resolve('foo/1.css'), tmpl.resources[0]);

                    basis.template.setTheme('custom');
                    this.is(1, tmpl.resources.length);
                    this.is(basis.path.resolve('foo/custom/2.css'), tmpl.resources[0]);
                  }
                }
              ]
            }
          ]
        },
        {
          name: 'Template include',
          testcase: [
            {
              name: 'Attribute modification',
              testcase: [
                {
                  name: '<b:include> with attributes',
                  testcase: [
                    {
                      name: '<b:include class> when class attribute does not exist',
                      test: function(){
                        var a = createTemplate('<span title="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" class="b"></b:include>');

                        /*nestedTemplate({
                          include: '<span title="a"/>',
                          attrs: {
                            class: 'b'
                          }
                        });*/

                        this.is(text('<span title="a" class="b"/>'), text(b))
                      }
                    },
                    {
                      name: '<b:include class> class when class attribute exists',
                      test: function(){
                        var a = createTemplate('<span class="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" class="b"></b:include>');

                        this.is(text('<span class="a b"/>'), text(b))
                      }
                    },
                    {
                      name: '<b:include class> class with binding',
                      test: function(){
                        var a = createTemplate('<span class="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" class="{b}"></b:include>');

                        this.is(text('<span class="a b"/>'), text(b, { b: 'b' }));

                        var a = createTemplate('<span class="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" class="{b} {b2}"></b:include>');

                        this.is(text('<span class="a b b2"/>'), text(b, { b: 'b', b2: 'b2' }));                        
                      }
                    },
                    {
                      name: '<b:include class> class binding and value',
                      test: function(){
                        var a = createTemplate('<span class="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" class="{b} c"></b:include>');

                        this.is(text('<span class="a c b"/>'), text(b, { b: 'b' }));

                        var a = createTemplate('<span class="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" class="a2 {b} {b2} c"></b:include>');

                        this.is(text('<span class="a a2 c b b2"/>'), text(b, { b: 'b', b2: 'b2' }));
                      }
                    },
                    {
                      name: '<b:include id> when id attribute does not exist',
                      test: function(){
                        var a = createTemplate('<span title="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" id="b"></b:include>');

                        this.is(text('<span title="a" id="b"/>'), text(b))
                      }
                    },
                    {
                      name: '<b:include id> when id exists',
                      test: function(){
                        var a = createTemplate('<span id="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '" id="b"></b:include>');

                        this.is(text('<span id="b"/>'), text(b))
                      }
                    }
                  ]
                },
                {
                  name: '<b:replace>',
                  testcase: [
                    {
                      name: 'nothing happen if no reference',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:replace ref="foo">x</b:replace></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'nothing happen if no ref attribute',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:replace>x</b:replace></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'replace token with single node',
                      test: function(){
                        var a = createTemplate('<span><span{foo}/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:replace ref="foo">x</b:replace></b:include>');

                        this.is(text('<span>x</span>'), text(b));
                      }
                    },
                    {
                      name: 'replace root element',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:replace ref="element">x</b:replace></b:include>');

                        this.is(text('x'), text(b));
                      }
                    },                    
                    {
                      name: 'replace token with multiple nodes',
                      test: function(){
                        var a = createTemplate('<span><span{foo}/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:replace ref="foo"><br/>x<br/></b:replace></b:include>');

                        this.is(text('<span><br/>x<br/></span>'), text(b));
                      }
                    }
                  ]
                },
                {
                  name: '<b:before>',
                  testcase: [
                    {
                      name: 'nothing happen if no reference',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:before ref="foo">x</b:before></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'nothing happen if no ref attribute',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:before>x</b:before></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'before token with single node',
                      test: function(){
                        var a = createTemplate('<span><span{foo}/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:before ref="foo">x</b:before></b:include>');

                        this.is(text('<span>x<span/></span>'), text(b));
                      }
                    },
                    {
                      name: 'before root element',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:before ref="element">x</b:before></b:include>');

                        this.is(text('x<span/>'), text(b));
                      }
                    },                    
                    {
                      name: 'before token with multiple nodes',
                      test: function(){
                        var a = createTemplate('<span><span{foo}/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:before ref="foo"><br/>x<br/></b:before></b:include>');

                        this.is(text('<span><br/>x<br/><span/></span>'), text(b));
                      }
                    }
                  ]
                },
                {
                  name: '<b:after>',
                  testcase: [
                    {
                      name: 'nothing happen if no reference',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:after ref="foo">x</b:after></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'nothing happen if no ref attribute',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:after>x</b:after></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'after token with single node',
                      test: function(){
                        var a = createTemplate('<span><span{foo}/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:after ref="foo">x</b:after></b:include>');

                        this.is(text('<span><span/>x</span>'), text(b));
                      }
                    },
                    {
                      name: 'after root element',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:after ref="element">x</b:after></b:include>');

                        this.is(text('<span/>x'), text(b));
                      }
                    },                    
                    {
                      name: 'after token with multiple nodes',
                      test: function(){
                        var a = createTemplate('<span><span{foo}/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:after ref="foo"><br/>x<br/></b:after></b:include>');

                        this.is(text('<span><span/><br/>x<br/></span>'), text(b));
                      }
                    }
                  ]
                },
                {
                  name: '<b:prepend>',
                  testcase: [
                    {
                      name: 'nothing happen if no reference',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:prepend ref="foo">x</b:prepend></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'nothing happen if no ref attribute',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:prepend>x</b:prepend></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'nothing happen if ref node is not an element',
                      test: function(){
                        var a = createTemplate('<span>{foo}</span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:prepend ref="foo">x</b:prepend></b:include>');

                        this.is(text('<span>{foo}</span>'), text(b));
                      }
                    },
                    {
                      name: 'prepend token with single node when no children',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:prepend ref="element">x</b:prepend></b:include>');

                        this.is(text('<span>x</span>'), text(b));
                      }
                    },
                    {
                      name: 'prepend token with single node',
                      test: function(){
                        var a = createTemplate('<span><span/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:prepend ref="element">x</b:prepend></b:include>');

                        this.is(text('<span>x<span/></span>'), text(b));
                      }
                    },                
                    {
                      name: 'prepend token with multiple nodes when no children',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:prepend ref="element"><br/>x<br/></b:prepend></b:include>');

                        this.is(text('<span><br/>x<br/></span>'), text(b));
                      }
                    },                
                    {
                      name: 'prepend token with multiple nodes',
                      test: function(){
                        var a = createTemplate('<span><span/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:prepend ref="element"><br/>x<br/></b:prepend></b:include>');

                        this.is(text('<span><br/>x<br/><span/></span>'), text(b));
                      }
                    }
                  ]
                },
                {
                  name: '<b:append>',
                  testcase: [
                    {
                      name: 'nothing happen if no reference',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:append ref="foo">x</b:append></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'nothing happen if no ref attribute',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:append>x</b:append></b:include>');

                        this.is(text('<span/>'), text(b));
                      }
                    },
                    {
                      name: 'nothing happen if ref node is not an element',
                      test: function(){
                        var a = createTemplate('<span>{foo}</span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:append ref="foo">x</b:append></b:include>');

                        this.is(text('<span>{foo}</span>'), text(b));
                      }
                    },
                    {
                      name: 'prepend token with single node when no children',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:append ref="element">x</b:append></b:include>');

                        this.is(text('<span>x</span>'), text(b));
                      }
                    },
                    {
                      name: 'prepend token with single node',
                      test: function(){
                        var a = createTemplate('<span><span/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:append ref="element">x</b:append></b:include>');

                        this.is(text('<span><span/>x</span>'), text(b));
                      }
                    },                
                    {
                      name: 'prepend token with multiple nodes when no children',
                      test: function(){
                        var a = createTemplate('<span/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:append ref="element"><br/>x<br/></b:append></b:include>');

                        this.is(text('<span><br/>x<br/></span>'), text(b));
                      }
                    },                
                    {
                      name: 'prepend token with multiple nodes',
                      test: function(){
                        var a = createTemplate('<span><span/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:append ref="element"><br/>x<br/></b:append></b:include>');

                        this.is(text('<span><span/><br/>x<br/></span>'), text(b));
                      }
                    }
                  ]
                },                
                {
                  name: '<b:set-attr>',
                  test: function(){
                    var a = createTemplate('<span title="a"/>');
                    var b = createTemplate('<b:include src="#' + a.templateId + '"><b:set-attr name="class" value="b"/></b:include>');

                    this.is(text('<span title="a" class="b"/>'), text(b))

                    var a = createTemplate('<span title="a"/>');
                    var b = createTemplate('<b:include src="#' + a.templateId + '"><b:set-attr name="title" value="b"/></b:include>');

                    this.is(text('<span title="b"/>'), text(b))
                  }
                },
                {
                  name: '<b:remove-attr>',
                  test: function(){
                    var a = createTemplate('<span title="a"/>');
                    var b = createTemplate('<b:include src="#' + a.templateId + '"><b:remove-attr name="class" value="b"/></b:include>');

                    this.is(text('<span title="a"/>'), text(b))

                    var a = createTemplate('<span title="a"/>');
                    var b = createTemplate('<b:include src="#' + a.templateId + '"><b:remove-attr name="title"/></b:include>');

                    this.is(text('<span/>'), text(b))
                  }
                },
                {
                  name: '<b:class>',
                  testcase: [
                    {
                      name: 'class not exists',
                      test: function(){
                        var a = createTemplate('<span title="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class value="b"/></b:include>');

                        this.is(text('<span title="a" class="b"/>'), text(b));
                      }
                    },
                    {
                      name: 'class exists',
                      test: function(){
                        var a = createTemplate('<span class="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class value="b"/></b:include>');

                        this.is(text('<span class="a b"/>'), text(b));
                      }
                    },
                    {
                      name: 'class not exists by reference',
                      test: function(){
                        var a = createTemplate('<span><b{reference}/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class ref="reference" value="b"/></b:include>');

                        this.is(text('<span><b class="b"/></span>'), text(b));
                      }
                    },
                    {
                      name: 'class exists by reference',
                      test: function(){
                        var a = createTemplate('<span><b{reference} class="a"/></span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class ref="reference" value="b"/></b:include>');

                        this.is(text('<span><b class="a b"/></span>'), text(b));
                      }
                    },
                    {
                      name: 'ignore name attribute',
                      test: function(){
                        var a = createTemplate('<span title="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class name="title" value="b"/></b:include>');

                        this.is(text('<span title="a" class="b"/>'), text(b))
                      }
                    },
                    {
                      name: 'ignore if no value attribute',
                      test: function(){
                        var a = createTemplate('<span title="a"/>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class/></b:include>');

                        this.is(text('<span title="a"/>'), text(b))
                      }
                    },
                    {
                      name: 'ignore set on non-element node',
                      test: function(){
                        var a = createTemplate('{a}');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class value="b"/></b:include>');

                        this.is(text('{a}'), text(b))
                      }
                    },
                    {
                      name: 'ignore set on non-element node by reference',
                      test: function(){
                        var a = createTemplate('<span>{reference}</span>');
                        var b = createTemplate('<b:include src="#' + a.templateId + '"><b:class ref="reference" value="b"/></b:include>');

                        this.is(text('<span>{reference}</span>'), text(b))
                      }
                    }
                  ]
                }
              ]
            }
          ]
        }/**/
      ];

    })());

//    if (top.nextTest)
//      top.nextTest();

  </script>
</body>

</html>