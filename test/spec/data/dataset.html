<!doctype html>

<html>

<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  <title>Basis Test Suite - Datasets</title>

  <style type="text/css">
    @import "../../style/style.css";

    /* */
    BODY
    {
      font-family: Georgia;
      font-size: small;
      _font-size: x-small;
    }
  </style>
  
  <script type="text/javascript" data-basis-config src="../../../src/basis.js"></script>
  <script type="text/javascript">
    (function(){
      basis.require('basis.event');

      var eventTypeFilter = function(event){ return event.type == this; };
      var proto = basis.event.Emitter.prototype;
      var eventsMap = {};
      var seed = 1;

      proto.emit_debug = function(event){
        if (!this.testEventId_)
        {
          this.testEventId_ = seed++;
          eventsMap[this.testEventId_] = [];
        }

        eventsMap[this.testEventId_].push(event);
      };

      window.getEvents = function(object, type){
        var events = eventsMap[object.testEventId_];

        if (events && type)
          events = events.filter(eventTypeFilter, type);

        return events;
      };

      window.eventCount = function(object, type){
        var events = getEvents(object, type);

        return events ? events.length : 0;
      };

      window.getLastEvent = function(object, type){
        var events = getEvents(object, type);

        return events && events[events.length - 1];
      };
    })();
  </script>
  <script type="text/javascript" src="../../test.js"></script>
  <script type="text/javascript" src="../../common.js"></script>
</head>

<body>
  <script type="text/javascript">
    loadTest((function(){
      basis.require('basis.data');
      basis.require('basis.data.dataset');
      basis.require('basis.ui');

      var nsData = basis.data;
      var DataObject = nsData.Object;
      
      return [
        {
          name: 'Main frame',
          testcase: [
            {
              name: 'accumulate events and updates',
              test: function(){
                var inserted = [];
                var deleted = [];
                var insertDoubles = 0;
                var deleteDoubles = 0;

                var items = basis.data.wrap(basis.array.create(10, function(i){ return i <= 5 ? i : 100 }), true);
                var dataset = new basis.data.Dataset({
                  items: items
                });

                var subset = new basis.data.dataset.Subset({
                  source: dataset,
                  rule: function(obj){
                    return obj.data.value % 2;
                  }
                });

                var slice = new basis.data.dataset.Slice({
                  source: subset,
                  rule: 'data.value',
                  handler: {
                    itemsChanged: function(sender, delta){
                      if (delta.inserted)
                        for (var i = 0; i < delta.inserted.length; i++)
                          insertDoubles += !inserted.add(delta.inserted[i]);

                      if (delta.deleted)
                        for (var i = 0; i < delta.deleted.length; i++)
                          deleteDoubles += !deleted.add(delta.deleted[i]);
                    }
                  }
                });

                basis.data.Dataset.setAccumulateState(true);
                items[6].update({ value: 3 });
                items[5].update({ value: 100 });
                basis.data.Dataset.setAccumulateState(false);

                this.is(0, insertDoubles);
                this.is(0, deleteDoubles);
              }
            },
            {
              name: 'accumulate events and updates',
              test: function(){
                var inserted = [];
                var deleted = [];
                var insertDoubles = 0;
                var deleteDoubles = 0;

                var items = basis.data.wrap(basis.array.create(10, function(i){ return i <= 5 ? i : 100 }), true);
                var dataset = new basis.data.Dataset({
                  items: items
                });

                var subset = new basis.data.dataset.Subset({
                  source: dataset,
                  rule: function(obj){
                    return obj.data.value % 2;
                  }
                });

                var slice = new basis.data.dataset.Slice({
                  source: subset,
                  rule: 'data.value',
                  handler: {
                    itemsChanged: function(sender, delta){
                      if (delta.inserted)
                        for (var i = 0; i < delta.inserted.length; i++)
                          insertDoubles += !inserted.add(delta.inserted[i]);

                      if (delta.deleted)
                        for (var i = 0; i < delta.deleted.length; i++)
                          deleteDoubles += !deleted.add(delta.deleted[i]);
                    }
                  }
                });

                basis.data.Dataset.setAccumulateState(true);
                items[5].update({ value: 100 });
                items[6].update({ value: 3 });
                basis.data.Dataset.setAccumulateState(false);

                this.is(0, insertDoubles);
                this.is(0, deleteDoubles);
              }
            },
            {
              name: 'Slice order',
              test: function(){
                var sliceSort = function(a, b){
                  return +(a.value > b.value) || -(a.value < b.value) || (a.object.basisObjectId - b.object.basisObjectId);
                };
                var sliceMap = function(array){
                  return array.map(function(item){
                    return item.value + '/' + item.object.basisObjectId;
                  });
                };

                var dataset = new basis.data.Dataset({
                  items: basis.array.create(10, function(v){
                    return new basis.data.Object({
                      data: { value: v % 3 }
                    })
                  })
                }); 
 
                var slice = new basis.data.dataset.Slice({
                  source: dataset,
                  limit: 3, 
                  rule: 'data.value'
                });

                // check index on create
                this.is(sliceMap(slice.index_.slice(0).sort(sliceSort)), sliceMap(slice.index_));
 
                // update items
                dataset.forEach(function(item){
                  item.update({
                    value: item.data.value + 10
                  })
                });

                this.is(sliceMap(slice.index_.slice(0).sort(sliceSort)), sliceMap(slice.index_));
 
                // random item update
                slice.index_[9].object.update({ value: 10 });
                this.is(sliceMap(slice.index_.slice(0).sort(sliceSort)), sliceMap(slice.index_));

                // set 1 value to every item
                var items = dataset.getItems().slice(0);
                items.forEach(function(item){
                  item.update({ value: 1 });
                });

                // check correct sorting and all index value must be 1
                this.is(sliceMap(slice.index_.slice(0).sort(sliceSort)), sliceMap(slice.index_));
                this.is(basis.array.create(10, 1), slice.index_.map(function(i){ return i.value }));

                // set 2 value to every item in random order
                var i = 3;
                items
                  .sort(function(a, b){
                    return a.basisObjectId * ((i += 111) % 19) - b.basisObjectId * ((i += 113) % 13);
                  })
                  .forEach(function(item){
                    item.update({ value: 2 });
                  });

                // correct sorting and all index value must be 2
                this.is(sliceMap(slice.index_.slice(0).sort(sliceSort)), sliceMap(slice.index_));
                this.is(basis.array.create(10, 2), slice.index_.map(function(i){ return i.value }));
              }
            }
          ]
        }
      ];

    })());

//    if (top.nextTest)
//      top.nextTest();

  </script>
</body>

</html>